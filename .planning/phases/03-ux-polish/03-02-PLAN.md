---
phase: 03-ux-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - W8Trackr/Views/SettingsView.swift
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can undo 'Delete All Entries' within 5 seconds"
    - "Toast with Undo button appears after delete confirmation"
    - "Tapping Undo restores all deleted entries"
    - "After undo window expires, entries are permanently gone"
    - "Undo only works once (can't re-undo)"
  artifacts:
    - path: "W8Trackr/Views/SettingsView.swift"
      provides: "Delete all entries with undo capability"
      contains: "pendingDeletionEntries"
  key_links:
    - from: "W8Trackr/Views/SettingsView.swift"
      to: "ToastView"
      via: "toast modifier with Undo action"
      pattern: "actionLabel.*Undo"
---

<objective>
Add undo capability for the "Delete All Entries" destructive action in Settings.

Purpose: Users should have a safety net for accidental bulk deletes (UX-03). This is a common iOS pattern - show toast with undo button for a few seconds before permanent deletion.
Output: Updated SettingsView.swift with undo infrastructure
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ux-polish/03-RESEARCH.md

# Relevant source files
@W8Trackr/Views/SettingsView.swift
@W8Trackr/Views/ToastView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add undo infrastructure to SettingsView</name>
  <files>W8Trackr/Views/SettingsView.swift</files>
  <action>
Add new state properties for undo functionality:
```swift
@State private var pendingDeletionEntries: [WeightEntry] = []
@State private var deletionTask: Task<Void, Never>?
@State private var showingUndoToast = false
```

Replace the existing `deleteAllEntries()` function with undo-aware version:
```swift
private func deleteAllEntries() {
    do {
        let entries = try modelContext.fetch(FetchDescriptor<WeightEntry>())
        guard !entries.isEmpty else { return }

        // Cancel any existing deletion task
        deletionTask?.cancel()

        // Cache entries for potential undo (copy the array)
        pendingDeletionEntries = entries

        // Delete from context
        for entry in entries {
            modelContext.delete(entry)
        }
        try modelContext.save()

        // Show undo toast
        showingUndoToast = true

        // Schedule cleanup after undo window expires
        deletionTask = Task {
            try? await Task.sleep(for: .seconds(5))
            guard !Task.isCancelled else { return }
            await MainActor.run {
                // Clear cache - entries are now permanently gone
                pendingDeletionEntries = []
                showingUndoToast = false
            }
        }

        // Don't dismiss - stay in Settings so user can undo
        // dismiss() - REMOVED
    } catch {
        showingDeleteErrorToast = true
    }
}
```

Add new `undoDelete()` function:
```swift
private func undoDelete() {
    // Cancel the cleanup task
    deletionTask?.cancel()
    deletionTask = nil

    // Re-insert cached entries
    for entry in pendingDeletionEntries {
        modelContext.insert(entry)
    }

    do {
        try modelContext.save()
        pendingDeletionEntries = []
        showingUndoToast = false
    } catch {
        // If undo fails, show error toast
        showingDeleteErrorToast = true
    }
}
```

IMPORTANT: Do NOT use SwiftData's UndoManager - it has documented bugs with bulk delete operations. The in-memory cache pattern is the recommended approach per research.

IMPORTANT: Use `Task.sleep(for:)` not `DispatchQueue.main.asyncAfter` - per CLAUDE.md concurrency rules.
  </action>
  <verify>
Build succeeds.
SettingsView contains `pendingDeletionEntries` state property.
SettingsView contains `undoDelete()` function.
No `DispatchQueue` usage in the new code.
  </verify>
  <done>
SettingsView has state for caching deleted entries and functions for delete-with-undo and restore.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire up undo toast and update existing toasts</name>
  <files>W8Trackr/Views/SettingsView.swift</files>
  <action>
Replace the existing success toast with the undo toast. Find:
```swift
.toast(
    isPresented: $showingDeleteSuccessToast,
    message: "All weight entries deleted",
    systemImage: "checkmark.circle.fill"
)
```

Replace with:
```swift
.toast(
    isPresented: $showingUndoToast,
    message: "All entries deleted",
    systemImage: "trash",
    actionLabel: "Undo",
    duration: 5
) {
    undoDelete()
}
```

Remove the `showingDeleteSuccessToast` state variable since it's no longer used - the undo toast replaces it.

Keep the error toast as-is for handling save failures.

Update the alert message to remove "This action cannot be undone" since it now CAN be undone:
Find:
```swift
Text("Are you sure you want to delete all weight entries? This action cannot be undone.")
```

Replace with:
```swift
Text("Are you sure you want to delete all weight entries? You'll have 5 seconds to undo.")
```

Also update the accessibility hint on the delete button:
Find:
```swift
.accessibilityHint("This will permanently delete all your weight tracking data. This action cannot be undone.")
```

Replace with:
```swift
.accessibilityHint("This will delete all your weight tracking data. You can undo within 5 seconds.")
```
  </action>
  <verify>
Build succeeds.
Grep confirms undo toast exists: `grep -n "actionLabel.*Undo" W8Trackr/Views/SettingsView.swift` returns match.
Grep confirms old success toast removed: `grep -n "showingDeleteSuccessToast" W8Trackr/Views/SettingsView.swift` returns nothing.
Grep confirms updated message: `grep -n "5 seconds" W8Trackr/Views/SettingsView.swift` returns matches for both alert and accessibility hint.
  </verify>
  <done>
Undo toast wired up. Delete confirmation mentions 5-second undo window. Old success toast removed.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with no errors
2. Delete All Entries shows toast with "Undo" button
3. Tapping Undo before 5 seconds restores entries
4. Alert text mentions undo capability
5. No SwiftData UndoManager usage (avoided due to known bugs)
6. No GCD/DispatchQueue usage (uses Task.sleep instead)
</verification>

<success_criteria>
- UX-03: Delete All Entries action can be undone within 5-second window
- Toast with Undo button appears after delete
- Undo restores all entries to SwiftData
- Build passes, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-ux-polish/03-02-SUMMARY.md`
</output>
