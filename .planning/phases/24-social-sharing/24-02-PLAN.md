---
phase: 24-social-sharing
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - W8Trackr/Views/Sharing/ShareProgressSheet.swift
  - W8Trackr/Views/Dashboard/DashboardView.swift
autonomous: false

must_haves:
  truths:
    - "User can open share sheet from Dashboard"
    - "Share sheet shows live preview of generated image"
    - "Privacy toggle regenerates image when changed"
    - "ShareLink presents system share sheet with image"
    - "User can successfully share image to Messages, Photos, or other apps"
  artifacts:
    - path: "W8Trackr/Views/Sharing/ShareProgressSheet.swift"
      provides: "Sheet with preview, privacy toggle, and ShareLink"
      contains: "ShareLink"
    - path: "W8Trackr/Views/Dashboard/DashboardView.swift"
      provides: "Share button in toolbar or card"
      contains: "ShareProgressSheet"
  key_links:
    - from: "W8Trackr/Views/Sharing/ShareProgressSheet.swift"
      to: "W8Trackr/Views/Sharing/ProgressImageGenerator.swift"
      via: "generateProgressImage call"
      pattern: "ProgressImageGenerator\\.generateProgressImage"
    - from: "W8Trackr/Views/Sharing/ShareProgressSheet.swift"
      to: "W8Trackr/Models/ShareableProgressImage.swift"
      via: "ShareLink item parameter"
      pattern: "ShareLink.*ShareableProgressImage"
    - from: "W8Trackr/Views/Dashboard/DashboardView.swift"
      to: "W8Trackr/Views/Sharing/ShareProgressSheet.swift"
      via: ".sheet presentation"
      pattern: "sheet.*ShareProgressSheet"
---

<objective>
Create the share sheet UI and integrate it into the Dashboard. Users will be able to tap a share button, see a preview of their progress image with a privacy toggle, and share via the system share sheet.

Purpose: Complete the user-facing sharing flow by wiring Plan 01's infrastructure into an accessible UI from the Dashboard.

Output:
- ShareProgressSheet.swift (sheet with preview + privacy toggle + ShareLink)
- Modified DashboardView.swift (share button triggers sheet)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-social-sharing/24-RESEARCH.md
@.planning/phases/24-social-sharing/24-01-SUMMARY.md

# Files from Plan 01 (must exist)
@W8Trackr/Models/ShareableProgressImage.swift
@W8Trackr/Views/Sharing/ProgressImageGenerator.swift
@W8Trackr/Views/Sharing/ShareableProgressView.swift

# Existing patterns
@W8Trackr/Views/ExportView.swift (ShareLink + sheet pattern)
@W8Trackr/Views/Dashboard/DashboardView.swift (integration target)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShareProgressSheet</name>
  <files>
    W8Trackr/Views/Sharing/ShareProgressSheet.swift
  </files>
  <action>
Create ShareProgressSheet.swift in W8Trackr/Views/Sharing/:

**Properties:**
```swift
@Environment(\.dismiss) private var dismiss
@AppStorage("shareHideExactWeights") private var hideExactWeights = true

let progressPercentage: Double
let weightChange: Double
let duration: String
let unit: WeightUnit

@State private var generatedImage: UIImage?
```

**Body structure (NavigationStack):**
1. VStack with spacing 20:
   - Image preview: If generatedImage exists, show Image(uiImage:) with:
     - .resizable()
     - .aspectRatio(contentMode: .fit)
     - .clipShape(.rect(cornerRadius: 12))
     - .padding()
   - Privacy toggle: Toggle("Hide exact weights", isOn: $hideExactWeights)
     - .padding(.horizontal)
     - Add .onChange(of: hideExactWeights) { _, _ in regenerateImage() }
   - Share button: If generatedImage exists, ShareLink with:
     - item: ShareableProgressImage(image: generatedImage, title: "My W8Trackr Progress")
     - preview: SharePreview("My W8Trackr Progress", image: Image(uiImage: generatedImage))
     - Label("Share", systemImage: "square.and.arrow.up") as label
     - .buttonStyle(.borderedProminent)
     - .frame(maxWidth: .infinity)
     - .padding(.horizontal)

2. Navigation modifiers:
   - .navigationTitle("Share Progress")
   - .navigationBarTitleDisplayMode(.inline)
   - .toolbar with cancellation action: Button("Cancel") { dismiss() }
   - .onAppear { regenerateImage() }

**Helper function:**
```swift
private func regenerateImage() {
    generatedImage = ProgressImageGenerator.generateProgressImage(
        progressPercentage: progressPercentage,
        weightChange: weightChange,
        duration: duration,
        showWeights: !hideExactWeights,
        unit: unit
    )
}
```

Add #Preview with sample data (progressPercentage: 65, weightChange: -12.5, duration: "3 months", unit: .lb)
  </action>
  <verify>
Build succeeds and preview renders: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build 2>&1 | grep -E "(error:|BUILD SUCCEEDED)"`
  </verify>
  <done>
ShareProgressSheet shows image preview, privacy toggle regenerates image, ShareLink presents system share sheet.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate into Dashboard</name>
  <files>
    W8Trackr/Views/Dashboard/DashboardView.swift
  </files>
  <action>
Modify DashboardView.swift to add share functionality:

1. Add state variable:
```swift
@State private var showingShareSheet = false
```

2. Add computed property for duration (calculate tracking duration from entries):
```swift
private var trackingDuration: String {
    guard let oldest = entries.min(by: { $0.date < $1.date }),
          let newest = entries.first else {
        return "Just started"
    }
    let days = Calendar.current.dateComponents([.day], from: oldest.date, to: newest.date).day ?? 0
    if days < 7 {
        return "\(days) days"
    } else if days < 30 {
        let weeks = days / 7
        return weeks == 1 ? "1 week" : "\(weeks) weeks"
    } else if days < 365 {
        let months = days / 30
        return months == 1 ? "1 month" : "\(months) months"
    } else {
        let years = days / 365
        return years == 1 ? "1 year" : "\(years) years"
    }
}
```

3. Add computed property for progress percentage:
```swift
private var progressPercentage: Double {
    guard startWeight != goalWeight else { return 100 }
    let totalChange = abs(startWeight - goalWeight)
    let currentChange = abs(startWeight - currentWeight)
    return min(100, (currentChange / totalChange) * 100)
}
```

4. Add computed property for weight change (from start):
```swift
private var weightChangeFromStart: Double {
    currentWeight - startWeight
}
```

5. Add toolbar button to NavigationStack (inside .navigationBarTitleDisplayMode modifier, after it):
```swift
.toolbar {
    ToolbarItem(placement: .primaryAction) {
        Button {
            showingShareSheet = true
        } label: {
            Image(systemName: "square.and.arrow.up")
        }
        .disabled(entries.isEmpty)
        .accessibilityLabel("Share progress")
    }
}
```

6. Add sheet modifier to NavigationStack (after .toolbar):
```swift
.sheet(isPresented: $showingShareSheet) {
    ShareProgressSheet(
        progressPercentage: progressPercentage,
        weightChange: weightChangeFromStart,
        duration: trackingDuration,
        unit: preferredWeightUnit
    )
}
```

Note: The share button should only be enabled when there are entries to share. Disabled state is already handled by `.disabled(entries.isEmpty)`.
  </action>
  <verify>
1. Build succeeds
2. SwiftLint passes: `swiftlint lint --path W8Trackr/Views/Dashboard/DashboardView.swift --quiet`
  </verify>
  <done>
Dashboard has share button in toolbar that opens ShareProgressSheet. Button is disabled when no entries exist.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete social sharing flow:
1. Share button in Dashboard toolbar
2. ShareProgressSheet with image preview and privacy toggle
3. System share sheet via ShareLink
4. Image renders at correct size with W8Trackr branding
  </what-built>
  <how-to-verify>
1. Launch app in Simulator with sample data
2. Navigate to Dashboard tab
3. Tap share button (square.and.arrow.up) in toolbar
4. Verify sheet appears with:
   - Progress image preview showing percentage, branding
   - "Hide exact weights" toggle (default ON)
   - Share button
5. Toggle "Hide exact weights" OFF - verify image updates to show weight change
6. Toggle back ON - verify weight change disappears from preview
7. Tap Share button - verify system share sheet appears
8. (Optional) Share to Photos or Messages to verify image quality
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Build succeeds with no errors
2. SwiftLint passes with 0 new violations
3. Dashboard shows share button in toolbar (only when entries exist)
4. Tapping share opens ShareProgressSheet
5. Privacy toggle regenerates image in real-time
6. ShareLink successfully presents system share sheet
7. Shared image is 600x315 at device scale with app branding
</verification>

<success_criteria>
SHAR-01: User can generate shareable progress image (from Dashboard share button)
SHAR-02: User can share via system share sheet (ShareLink integration)
SHAR-03: User can hide exact weight values in shared image (privacy toggle, default ON)
</success_criteria>

<output>
After completion, create `.planning/phases/24-social-sharing/24-02-SUMMARY.md`
</output>
