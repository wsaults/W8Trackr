---
phase: 22-widgets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - W8TrackrWidget/W8TrackrWidget.swift
  - W8TrackrWidget/WeightWidgetEntry.swift
  - W8TrackrWidget/WeightWidgetProvider.swift
  - W8TrackrWidget/W8TrackrWidget.entitlements
  - W8TrackrWidget/Info.plist
autonomous: true

must_haves:
  truths:
    - "Widget extension target exists in Xcode project"
    - "Widget extension shares App Group with main app"
    - "Widget can access SwiftData container"
    - "Timeline provider fetches weight entries"
  artifacts:
    - path: "W8TrackrWidget/W8TrackrWidget.swift"
      provides: "Widget bundle entry point"
      contains: "@main"
    - path: "W8TrackrWidget/WeightWidgetEntry.swift"
      provides: "Timeline entry model with trend, progress data"
      contains: "TimelineEntry"
    - path: "W8TrackrWidget/WeightWidgetProvider.swift"
      provides: "Data fetching and timeline generation"
      contains: "TimelineProvider"
    - path: "W8TrackrWidget/W8TrackrWidget.entitlements"
      provides: "App Group entitlement matching main app"
      contains: "group.com.saults.W8Trackr"
  key_links:
    - from: "W8TrackrWidget/WeightWidgetProvider.swift"
      to: "SharedModelContainer"
      via: "SwiftData fetch"
      pattern: "SharedModelContainer.sharedModelContainer"
    - from: "W8TrackrWidget/WeightWidgetProvider.swift"
      to: "WeightEntry"
      via: "FetchDescriptor"
      pattern: "FetchDescriptor<WeightEntry>"
---

<objective>
Create the widget extension target and core infrastructure for W8Trackr home screen widgets.

Purpose: Establish the foundation for widgets that will display weight data. This includes the Xcode target configuration, App Group entitlements for shared data access, timeline entry model, and data provider.

Output: Widget extension target with functioning data pipeline (can fetch from SwiftData), ready for UI views in Plan 22-02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-widgets/22-CONTEXT.md
@.planning/phases/22-widgets/22-RESEARCH.md
@.planning/phases/21-infrastructure-migration/21-02-SUMMARY.md

@W8Trackr/Shared/SharedModelContainer.swift
@W8Trackr/Models/WeightEntry.swift
@W8Trackr/W8Trackr.entitlements
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Widget Extension Target</name>
  <files>
    W8TrackrWidget/W8TrackrWidget.swift
    W8TrackrWidget/W8TrackrWidget.entitlements
    W8TrackrWidget/Info.plist
    W8Trackr.xcodeproj/project.pbxproj
  </files>
  <action>
Create a new Widget Extension target named "W8TrackrWidget" in the Xcode project:

1. Create directory structure: `W8TrackrWidget/`

2. Create `W8TrackrWidget.entitlements` with App Group matching main app:
   - `com.apple.security.application-groups`: `["group.com.saults.W8Trackr"]`
   - Do NOT include CloudKit or HealthKit entitlements (widgets are read-only)

3. Create `Info.plist` for widget extension:
   - `CFBundleDisplayName`: "W8Trackr Widget"
   - `NSExtension` dictionary with `NSExtensionPointIdentifier`: "com.apple.widgetkit-extension"

4. Create `W8TrackrWidget.swift` as the widget bundle entry point:
   ```swift
   import WidgetKit
   import SwiftUI

   @main
   struct W8TrackrWidgetBundle: WidgetBundle {
       var body: some Widget {
           WeightWidget()
       }
   }

   struct WeightWidget: Widget {
       let kind: String = "WeightWidget"

       var body: some WidgetConfiguration {
           StaticConfiguration(kind: kind, provider: WeightWidgetProvider()) { entry in
               WeightWidgetEntryView(entry: entry)
                   .containerBackground(.fill.tertiary, for: .widget)
           }
           .configurationDisplayName("Weight Tracker")
           .description("See your current weight and progress at a glance.")
           .supportedFamilies([.systemSmall, .systemMedium, .systemLarge])
       }
   }

   struct WeightWidgetEntryView: View {
       @Environment(\.widgetFamily) var family
       let entry: WeightWidgetEntry

       var body: some View {
           // Placeholder - views implemented in Plan 22-02
           Text(entry.currentWeight.map { "\($0)" } ?? "No data")
       }
   }
   ```

5. Update `project.pbxproj` to add:
   - New target "W8TrackrWidget" (widget extension)
   - Target membership for shared files: WeightEntry.swift, SharedModelContainer.swift, Milestone.swift (CompletedMilestone is in schema)
   - App Group entitlement
   - iOS 26.0 deployment target
   - Link to WidgetKit and SwiftUI frameworks

IMPORTANT:
- WeightEntry.swift and SharedModelContainer.swift must be added to BOTH targets
- Widget target should NOT have CloudKit entitlement (read-only from shared container)
- Use `groupContainer: .identifier("group.com.saults.W8Trackr")` for SwiftData access
  </action>
  <verify>
1. `xcodebuild -list -project W8Trackr.xcodeproj` shows W8TrackrWidget target
2. Build widget target: `xcodebuild -project W8Trackr.xcodeproj -scheme W8TrackrWidget -sdk iphonesimulator build`
  </verify>
  <done>
Widget extension target exists, builds successfully, has correct App Group entitlement matching main app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Timeline Entry and Provider</name>
  <files>
    W8TrackrWidget/WeightWidgetEntry.swift
    W8TrackrWidget/WeightWidgetProvider.swift
  </files>
  <action>
Create the timeline entry model and provider that fetches weight data from SwiftData.

1. Create `WeightWidgetEntry.swift`:
```swift
import WidgetKit

/// Timeline entry containing all data needed to render widget views
struct WeightWidgetEntry: TimelineEntry {
    let date: Date

    /// Current weight as whole number (per CONTEXT.md), nil if no entries
    let currentWeight: Int?

    /// Weight unit string ("lb" or "kg")
    let weightUnit: String

    /// Goal weight as whole number, nil if not set
    let goalWeight: Int?

    /// Progress toward goal (0.0 to 1.0+), nil if no goal or no current weight
    let progressPercent: Double?

    /// Weight trend based on 7-day comparison
    let trend: WeightTrend

    /// Recent entries for sparkline chart (last 7 days, oldest first)
    let chartData: [ChartDataPoint]

    /// Weight trend direction
    enum WeightTrend {
        case up, down, neutral, unknown

        var systemImage: String {
            switch self {
            case .up: return "arrow.up"
            case .down: return "arrow.down"
            case .neutral: return "minus"
            case .unknown: return "minus"
            }
        }
    }

    /// Data point for sparkline chart
    struct ChartDataPoint: Identifiable {
        let id = UUID()
        let date: Date
        let weight: Double
    }

    /// Empty state for when no data exists
    static var empty: WeightWidgetEntry {
        WeightWidgetEntry(
            date: .now,
            currentWeight: nil,
            weightUnit: "lb",
            goalWeight: nil,
            progressPercent: nil,
            trend: .unknown,
            chartData: []
        )
    }

    /// Placeholder for widget gallery
    static var placeholder: WeightWidgetEntry {
        WeightWidgetEntry(
            date: .now,
            currentWeight: 175,
            weightUnit: "lb",
            goalWeight: 165,
            progressPercent: 0.6,
            trend: .down,
            chartData: [
                ChartDataPoint(date: Calendar.current.date(byAdding: .day, value: -6, to: .now)!, weight: 180),
                ChartDataPoint(date: Calendar.current.date(byAdding: .day, value: -5, to: .now)!, weight: 179),
                ChartDataPoint(date: Calendar.current.date(byAdding: .day, value: -4, to: .now)!, weight: 178),
                ChartDataPoint(date: Calendar.current.date(byAdding: .day, value: -3, to: .now)!, weight: 177),
                ChartDataPoint(date: Calendar.current.date(byAdding: .day, value: -2, to: .now)!, weight: 176),
                ChartDataPoint(date: Calendar.current.date(byAdding: .day, value: -1, to: .now)!, weight: 175),
                ChartDataPoint(date: .now, weight: 175)
            ]
        )
    }
}
```

2. Create `WeightWidgetProvider.swift`:
```swift
import WidgetKit
import SwiftData

struct WeightWidgetProvider: TimelineProvider {
    typealias Entry = WeightWidgetEntry

    func placeholder(in context: Context) -> WeightWidgetEntry {
        .placeholder
    }

    func getSnapshot(in context: Context, completion: @escaping (WeightWidgetEntry) -> Void) {
        // For preview/gallery, use placeholder
        if context.isPreview {
            completion(.placeholder)
            return
        }
        completion(fetchCurrentEntry())
    }

    func getTimeline(in context: Context, completion: @escaping (Timeline<WeightWidgetEntry>) -> Void) {
        let entry = fetchCurrentEntry()
        // Refresh every 4 hours as fallback; main app triggers immediate refresh on data change
        let nextRefresh = Calendar.current.date(byAdding: .hour, value: 4, to: .now) ?? .now
        let timeline = Timeline(entries: [entry], policy: .after(nextRefresh))
        completion(timeline)
    }

    // MARK: - Data Fetching

    private func fetchCurrentEntry() -> WeightWidgetEntry {
        let context = SharedModelContainer.sharedModelContainer.mainContext

        // Fetch entries sorted newest first
        var descriptor = FetchDescriptor<WeightEntry>(
            sortBy: [SortDescriptor(\.date, order: .reverse)]
        )
        descriptor.fetchLimit = 30 // Enough for 7-day window

        guard let entries = try? context.fetch(descriptor), !entries.isEmpty else {
            return .empty
        }

        // Read preferences from shared defaults
        let defaults = SharedModelContainer.sharedDefaults
        let unitString = defaults?.string(forKey: "preferredWeightUnit") ?? "lb"
        let unit = WeightUnit(rawValue: unitString) ?? .lb

        // Goal weight from shared defaults
        let goalWeight: Int?
        if let goalValue = defaults?.object(forKey: "goalWeight") as? Double, goalValue > 0 {
            goalWeight = Int(goalValue)
        } else {
            goalWeight = nil
        }

        // Current weight (most recent entry)
        let currentEntry = entries[0]
        let currentWeight = Int(currentEntry.weightValue(in: unit))

        // Calculate progress toward goal
        let progressPercent: Double?
        if let goal = goalWeight, let startWeight = entries.last {
            let startValue = startWeight.weightValue(in: unit)
            let currentValue = currentEntry.weightValue(in: unit)
            let goalValue = Double(goal)

            // Progress = how far along from start to goal
            let totalChange = startValue - goalValue
            let actualChange = startValue - currentValue

            if abs(totalChange) > 0.1 {
                progressPercent = actualChange / totalChange
            } else {
                progressPercent = nil
            }
        } else {
            progressPercent = nil
        }

        // Calculate trend from 7-day window
        let trend = calculateTrend(entries: entries, unit: unit)

        // Prepare chart data (last 7 days, oldest first)
        let sevenDaysAgo = Calendar.current.date(byAdding: .day, value: -7, to: .now) ?? .now
        let chartData = entries
            .filter { $0.date >= sevenDaysAgo }
            .map { WeightWidgetEntry.ChartDataPoint(date: $0.date, weight: $0.weightValue(in: unit)) }
            .sorted { $0.date < $1.date } // Oldest first for chart

        return WeightWidgetEntry(
            date: .now,
            currentWeight: currentWeight,
            weightUnit: unitString,
            goalWeight: goalWeight,
            progressPercent: progressPercent,
            trend: trend,
            chartData: chartData
        )
    }

    private func calculateTrend(entries: [WeightEntry], unit: WeightUnit) -> WeightWidgetEntry.WeightTrend {
        let sevenDaysAgo = Calendar.current.date(byAdding: .day, value: -7, to: .now) ?? .now
        let recentEntries = entries.filter { $0.date >= sevenDaysAgo }

        guard recentEntries.count >= 2,
              let newest = recentEntries.first,
              let oldest = recentEntries.last else {
            return .unknown
        }

        let diff = newest.weightValue(in: unit) - oldest.weightValue(in: unit)

        // Neutral threshold: less than 0.5 unit change (per spec)
        if abs(diff) < 0.5 {
            return .neutral
        }

        return diff > 0 ? .up : .down
    }
}
```

IMPORTANT:
- Use SharedModelContainer.sharedModelContainer for SwiftData access (same as main app)
- Read unit preference from SharedModelContainer.sharedDefaults (App Group UserDefaults)
- Trend calculation uses 7-day window per CONTEXT.md
- Neutral threshold is 0.5 units per spec
  </action>
  <verify>
1. Build succeeds: `xcodebuild -project W8Trackr.xcodeproj -scheme W8TrackrWidget -sdk iphonesimulator build`
2. No SwiftLint errors: `swiftlint lint W8TrackrWidget/`
  </verify>
  <done>
Timeline entry model contains all required data (weight, trend, progress, chart points). Provider fetches from SwiftData via App Group container and calculates trend.
  </done>
</task>

</tasks>

<verification>
1. Widget extension target exists and builds
2. App Group entitlement matches main app (`group.com.saults.W8Trackr`)
3. WeightEntry.swift and SharedModelContainer.swift are in both target memberships
4. Timeline provider compiles and can access SwiftData
</verification>

<success_criteria>
- Widget extension target builds successfully
- Entitlements configured for App Group sharing
- Timeline entry model has all fields needed for small/medium/large views
- Provider fetches weight data from shared SwiftData container
- Provider reads preferences from shared UserDefaults
</success_criteria>

<output>
After completion, create `.planning/phases/22-widgets/22-01-SUMMARY.md`
</output>
