---
phase: 20-full-accessibility-support
plan: 03
type: execute
wave: 2
depends_on: [20-01, 20-02]
files_modified:
  - W8TrackrUITests/AccessibilityTests.swift
autonomous: true

must_haves:
  truths:
    - "Automated accessibility tests exist for all main screens"
    - "performAccessibilityAudit() is called on Dashboard, Logbook, and Settings"
    - "Tests run as part of UI test suite"
    - "Accessibility violations cause test failures"
  artifacts:
    - path: "W8TrackrUITests/AccessibilityTests.swift"
      provides: "Automated accessibility test suite"
      contains: "performAccessibilityAudit"
      min_lines: 40
  key_links:
    - from: "AccessibilityTests"
      to: "XCUIApplication"
      via: "performAccessibilityAudit API"
      pattern: "performAccessibilityAudit"
---

<objective>
Create automated accessibility tests using XCTest's performAccessibilityAudit() API.

Purpose: Automated tests catch accessibility regressions during development. The performAccessibilityAudit() API (Xcode 15+) checks for common accessibility issues like missing labels, low contrast, and small touch targets.

Output: New test file with accessibility audits for all main screens that runs in CI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-full-accessibility-support/20-RESEARCH.md
@.planning/phases/20-full-accessibility-support/20-01-SUMMARY.md
@.planning/phases/20-full-accessibility-support/20-02-SUMMARY.md
@W8TrackrUITests/ScreenshotTests.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AccessibilityTests.swift with automated audits</name>
  <files>
    W8TrackrUITests/AccessibilityTests.swift
  </files>
  <action>
Create a new test file for automated accessibility audits:

**W8TrackrUITests/AccessibilityTests.swift:**

```swift
//
//  AccessibilityTests.swift
//  W8TrackrUITests
//
//  Created by Claude on [current date].
//

import XCTest

/// Automated accessibility tests for W8Trackr.
///
/// These tests use XCTest's performAccessibilityAudit() API to check for common
/// accessibility issues like missing labels, low contrast, and small touch targets.
///
/// Run with: xcodebuild test -project W8Trackr.xcodeproj -scheme W8Trackr -sdk iphonesimulator -only-testing:W8TrackrUITests/AccessibilityTests
@MainActor
final class AccessibilityTests: XCTestCase {
    var app: XCUIApplication!

    override func setUpWithError() throws {
        continueAfterFailure = false
        app = XCUIApplication()
        // Skip onboarding for accessibility tests
        app.launchArguments += ["-hasCompletedOnboarding", "YES"]
        app.launch()
    }

    override func tearDownWithError() throws {
        app = nil
    }

    // MARK: - Dashboard Tab

    func testDashboardAccessibility() throws {
        // Navigate to Dashboard (should be default)
        let dashboardTab = app.tabBars.buttons["Dashboard"]
        XCTAssertTrue(dashboardTab.waitForExistence(timeout: 5))
        dashboardTab.tap()

        // Perform accessibility audit
        try app.performAccessibilityAudit()
    }

    // MARK: - Logbook Tab

    func testLogbookAccessibility() throws {
        // Navigate to Logbook
        let logbookTab = app.tabBars.buttons["Logbook"]
        XCTAssertTrue(logbookTab.waitForExistence(timeout: 5))
        logbookTab.tap()

        // Wait for content to load
        _ = app.staticTexts.firstMatch.waitForExistence(timeout: 2)

        // Perform accessibility audit
        try app.performAccessibilityAudit()
    }

    // MARK: - Settings Tab

    func testSettingsAccessibility() throws {
        // Navigate to Settings
        let settingsTab = app.tabBars.buttons["Settings"]
        XCTAssertTrue(settingsTab.waitForExistence(timeout: 5))
        settingsTab.tap()

        // Wait for content to load
        _ = app.staticTexts["Weight Unit"].waitForExistence(timeout: 2)

        // Perform accessibility audit
        try app.performAccessibilityAudit()
    }

    // MARK: - Add Entry Sheet

    func testAddEntryAccessibility() throws {
        // Tap the add button (trailing tab bar button)
        let addButton = app.tabBars.buttons["Add"]
        XCTAssertTrue(addButton.waitForExistence(timeout: 5))
        addButton.tap()

        // Wait for sheet to appear
        let cancelButton = app.buttons["Cancel"]
        XCTAssertTrue(cancelButton.waitForExistence(timeout: 5))

        // Perform accessibility audit on the entry sheet
        try app.performAccessibilityAudit()

        // Dismiss sheet
        cancelButton.tap()
    }

    // MARK: - Dynamic Type

    func testDashboardWithLargeText() throws {
        // Relaunch with accessibility large text
        app.terminate()
        app.launchArguments += [
            "-UIPreferredContentSizeCategoryName",
            "UICTContentSizeCategoryAccessibilityExtraExtraExtraLarge"
        ]
        app.launch()

        // Navigate to Dashboard
        let dashboardTab = app.tabBars.buttons["Dashboard"]
        XCTAssertTrue(dashboardTab.waitForExistence(timeout: 5))
        dashboardTab.tap()

        // Perform accessibility audit with large text
        try app.performAccessibilityAudit()
    }
}
```

Key implementation notes:
1. Mark class with `@MainActor` for Swift 6 concurrency compliance (matching ScreenshotTests pattern)
2. Use `app.launchArguments += ["-hasCompletedOnboarding", "YES"]` to skip onboarding
3. Use `waitForExistence(timeout:)` before audits to ensure UI is loaded
4. The `performAccessibilityAudit()` API throws if issues are found
5. Test with XXXL accessibility text size to catch Dynamic Type issues
6. Each test function focuses on one screen/flow

Note: If specific audit rules need to be ignored (documented false positives), use the audit filter:
```swift
try app.performAccessibilityAudit { issue in
    // Return false to fail on this issue, true to pass
    // Example: ignore specific known false positives
    return true
}
```

Only add filters if tests reveal false positives during execution.
  </action>
  <verify>
File exists: `test -f W8TrackrUITests/AccessibilityTests.swift`
Build succeeds: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build-for-testing`
Tests compile: grep for "performAccessibilityAudit" in new file
  </verify>
  <done>
AccessibilityTests.swift created with automated accessibility audits for Dashboard, Logbook, Settings, and Add Entry screens. Tests include Dynamic Type verification at XXXL size.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run accessibility tests and fix any audit failures</name>
  <files>
    W8TrackrUITests/AccessibilityTests.swift
  </files>
  <action>
Run the accessibility tests and address any failures:

1. Run the accessibility test suite:
   ```bash
   xcodebuild test \
     -project W8Trackr.xcodeproj \
     -scheme W8Trackr \
     -sdk iphonesimulator \
     -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
     -only-testing:W8TrackrUITests/AccessibilityTests \
     2>&1 | xcpretty || true
   ```

2. If tests pass: Great! Move to verification.

3. If tests fail with accessibility issues:
   - Review the failure messages to identify specific issues
   - If issues are genuine: Go back to relevant view files and fix (add labels, increase touch targets)
   - If issues are false positives: Add filter to `performAccessibilityAudit { issue in ... }`

4. If tests fail for non-accessibility reasons (e.g., element not found):
   - Adjust selectors or wait times
   - Ensure test setup correctly skips onboarding

Common audit issue types and fixes:
- "Element has no accessibility label" -> Add `.accessibilityLabel()`
- "Touch target too small" -> Add `.frame(minWidth: 44, minHeight: 44)`
- "Contrast too low" -> Adjust colors (may require design review)

Document any filters added with comments explaining why the issue is a false positive.
  </action>
  <verify>
Accessibility tests pass: `xcodebuild test -project W8Trackr.xcodeproj -scheme W8Trackr -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 16 Pro' -only-testing:W8TrackrUITests/AccessibilityTests`
If filters added, they have explanatory comments
  </verify>
  <done>
Accessibility tests run and pass. Any genuine accessibility issues discovered during testing are fixed. False positives are documented with filters.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. W8TrackrUITests/AccessibilityTests.swift exists with at least 5 test methods
2. Tests use performAccessibilityAudit() API
3. Tests cover Dashboard, Logbook, Settings, and Add Entry screens
4. Tests include Dynamic Type verification
5. All accessibility tests pass when run
6. Any audit filters have explanatory comments
</verification>

<success_criteria>
1. AccessibilityTests.swift file exists in W8TrackrUITests/
2. Tests use performAccessibilityAudit() for automated checking
3. Tests cover all main app screens
4. Tests verify Dynamic Type at large sizes
5. All tests pass (or have documented false positive filters)
6. Tests can be run in CI with: `xcodebuild test -only-testing:W8TrackrUITests/AccessibilityTests`
</success_criteria>

<output>
After completion, create `.planning/phases/20-full-accessibility-support/20-03-SUMMARY.md`
</output>
