---
phase: 26-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - W8TrackrTests/WeightEntryCRUDTests.swift
  - W8TrackrTests/HealthSyncFlowTests.swift
autonomous: true

must_haves:
  truths:
    - "Unit tests verify WeightEntry create, read, update, and delete operations"
    - "Unit tests verify HealthKit sync logic with mock data"
    - "All tests pass with zero failures"
  artifacts:
    - path: "W8TrackrTests/WeightEntryCRUDTests.swift"
      provides: "CRUD lifecycle tests for WeightEntry"
      exports: ["WeightEntryCRUDTests"]
    - path: "W8TrackrTests/HealthSyncFlowTests.swift"
      provides: "HealthKit sync flow tests with MockHealthStore"
      exports: ["HealthSyncFlowTests"]
  key_links:
    - from: "WeightEntryCRUDTests.swift"
      to: "WeightEntry"
      via: "@testable import"
      pattern: "WeightEntry.*weightValue"
    - from: "HealthSyncFlowTests.swift"
      to: "HealthSyncManager"
      via: "MockHealthStore injection"
      pattern: "HealthSyncManager.*mockStore"
---

<objective>
Complete test coverage for Phase 26 by addressing gaps identified in research.

Purpose: Satisfy TEST-01 and TEST-02 requirements with explicit CRUD lifecycle and HealthKit sync flow tests. TEST-03 (EWMA), TEST-04/TEST-05 (UI tests - removed), and TEST-06 (MockHealthStore) are already satisfied.

Output: Two new test files providing complete coverage for weight entry operations and HealthKit sync logic.
</objective>

<execution_context>
@~/.claude/agents/gsd-executor.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-testing/26-RESEARCH.md
@W8TrackrTests/WeightEntryTests.swift
@W8TrackrTests/HealthSyncManagerTests.swift
@W8Trackr/Models/WeightEntry.swift
@W8Trackr/Managers/HealthSyncManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WeightEntry CRUD lifecycle tests</name>
  <files>W8TrackrTests/WeightEntryCRUDTests.swift</files>
  <action>
Create a new test file `WeightEntryCRUDTests.swift` with Swift Testing framework tests for:

1. **Create operations** (some already exist but add explicit lifecycle test):
   - Create entry with all fields populated
   - Create entry with minimal fields (weight only)
   - Create entry preserves all optional fields correctly

2. **Update operations** (gap identified in research):
   - Update weightValue modifies the value correctly
   - Update weightUnit changes stored unit
   - Update date changes timestamp
   - Update note modifies optional field
   - Update bodyFatPercentage modifies optional field
   - Update multiple fields in sequence maintains all changes

3. **Delete preparation** (model-level, not persistence):
   - Entry properties remain accessible before deletion
   - Entry can be marked for deletion (pendingHealthSync pattern)

Follow existing patterns from WeightEntryTests.swift:
- Use `struct` not `class` for test suites
- Use `@Test func` not `func test*`
- Use `#expect()` not `XCTAssert*()`
- Use `makeEntry()` helper pattern for date-relative entries

Do NOT test SwiftData persistence (model context operations) - focus on model property behavior.
  </action>
  <verify>
Run: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -sdk iphonesimulator test -only-testing:W8TrackrTests/WeightEntryCRUDTests 2>&1 | tail -20`
All tests pass.
  </verify>
  <done>WeightEntryCRUDTests.swift exists with 8+ tests covering create, update lifecycle operations. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add HealthKit sync flow tests</name>
  <files>W8TrackrTests/HealthSyncFlowTests.swift</files>
  <action>
Create a new test file `HealthSyncFlowTests.swift` with Swift Testing framework tests for HealthKit sync operations using existing MockHealthStore.

1. **Sync enable/disable flow**:
   - Enable import sets isHealthImportEnabled to true
   - Disable import sets isHealthImportEnabled to false
   - Enable persists across manager instances (using makeTestDefaults pattern)

2. **Authorization flow with sync**:
   - Successful authorization updates isAuthorized state
   - Denied authorization keeps isHealthImportEnabled false
   - Authorization error is thrown to caller

3. **Sync status transitions**:
   - Initial status is idle
   - Status changes during operations (if observable)

4. **Save/delete tracking via MockHealthStore**:
   - MockHealthStore.saveCalled tracks save operations
   - MockHealthStore.deleteCalled tracks delete operations
   - MockHealthStore.deletedSample captures deleted sample

Follow existing patterns from HealthSyncManagerTests.swift:
- Mark test suites with `@MainActor` (HealthSyncManager is @MainActor)
- Use `makeTestDefaults()` helper for isolated UserDefaults
- Inject MockHealthStore via initializer
- Use `async throws` for authorization tests

Do NOT test actual HealthKit import (requires real HKHealthStore with HKAnchoredObjectQueryDescriptor).
  </action>
  <verify>
Run: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -sdk iphonesimulator test -only-testing:W8TrackrTests/HealthSyncFlowTests 2>&1 | tail -20`
All tests pass.
  </verify>
  <done>HealthSyncFlowTests.swift exists with 8+ tests covering sync enable/disable, authorization, and status transitions. All tests pass.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Run full test suite:
   ```bash
   xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -sdk iphonesimulator test 2>&1 | grep -E "(Test Suite|passed|failed)"
   ```
   Expected: All test suites pass, zero failures.

2. Verify test count increased:
   ```bash
   grep -r "@Test func" W8TrackrTests/ | wc -l
   ```
   Expected: 16+ more tests than before (baseline ~80).

3. SwiftLint passes:
   ```bash
   swiftlint lint W8TrackrTests/WeightEntryCRUDTests.swift W8TrackrTests/HealthSyncFlowTests.swift
   ```
   Expected: Zero violations.
</verification>

<success_criteria>
- WeightEntryCRUDTests.swift created with CRUD lifecycle tests
- HealthSyncFlowTests.swift created with sync flow tests
- All new tests pass
- Full test suite passes with zero failures
- SwiftLint passes on new files
- TEST-01 requirement satisfied (CRUD operations tested)
- TEST-02 requirement satisfied (HealthKit sync logic tested)
</success_criteria>

<output>
After completion, create `.planning/phases/26-testing/26-01-SUMMARY.md` using the summary template.
</output>
