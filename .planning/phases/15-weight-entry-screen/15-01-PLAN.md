---
phase: 15-weight-entry-screen
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - W8Trackr/Views/WeightEntryView.swift
autonomous: true

must_haves:
  truths:
    - "Weight text field auto-focuses when sheet opens"
    - "Decimal pad keyboard appears for weight entry"
    - "Weight label appears above weight field"
    - "Unit suffix (lb/kg) displays inside the weight field"
    - "Date navigation uses left/right arrows for new entries"
    - "Right arrow is disabled when date is today (canNavigateForward logic)"
    - "Notes label appears above notes field"
    - "Notes field shows 2-3 lines, expands as user types"
    - "Character counter appears when under 50 characters remaining"
    - "More... button expands body fat field"
    - "Save button disabled when weight is invalid"
    - "Discard confirmation shows when dismissing with unsaved changes"
    - "Edit mode keeps DatePicker for any date selection"
  artifacts:
    - path: "W8Trackr/Views/WeightEntryView.swift"
      provides: "Redesigned weight entry form"
      contains: "@FocusState"
  key_links:
    - from: "WeightEntryView"
      to: "@FocusState"
      via: ".focused() and .task {}"
      pattern: "focusedField = .weight"
    - from: "WeightEntryView"
      to: "interactiveDismissDisabled"
      via: "hasUnsavedChanges computed property"
      pattern: "interactiveDismissDisabled.*hasUnsavedChanges"
    - from: "Date navigation forward button"
      to: "Calendar.isDateInToday"
      via: "canNavigateForward computed property"
      pattern: "disabled(!canNavigateForward)"
---

<objective>
Redesign WeightEntryView as a focused text input form with date navigation, expandable body fat section, and unsaved changes protection.

Purpose: Replace plus/minus button controls with direct text entry for faster, simpler weight logging
Output: Fully redesigned WeightEntryView.swift with all CONTEXT.md features
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-weight-entry-screen/15-CONTEXT.md
@.planning/phases/15-weight-entry-screen/15-RESEARCH.md

# Source files
@W8Trackr/Views/WeightEntryView.swift
@W8Trackr/Models/WeightEntry.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign WeightEntryView with text input form</name>
  <files>W8Trackr/Views/WeightEntryView.swift</files>
  <action>
Completely restructure WeightEntryView to implement the CONTEXT.md design:

**Remove:**
- All WeightAdjustmentButton components (4 buttons in HStack)
- Import or usage of WeightAdjustmentButton
- UIImpactFeedbackGenerator instances (lightFeedbackGenerator, mediumFeedbackGenerator)
- Inline validation message display (validation still happens, just disables save)

**Add FocusState for auto-focus:**
```swift
enum EntryField: Hashable { case weight, notes, bodyFat }
@FocusState private var focusedField: EntryField?
```

**Add state for expanded section and unsaved changes:**
```swift
@State private var showMoreFields = false
@State private var showDiscardAlert = false

// Capture initial values for change detection
private let initialWeight: Double
private let initialNote: String
private let initialDate: Date
private let initialBodyFat: Double?
```

**Update init to capture initial values:**
- Store initialWeight, initialNote, initialDate, initialBodyFat from existingEntry or defaults
- These are immutable (let) values set once at init for comparison

**Add hasUnsavedChanges computed property:**
```swift
private var hasUnsavedChanges: Bool {
    // Round to 1 decimal place to avoid floating point comparison issues
    let weightChanged = (weight * 10).rounded() != (initialWeight * 10).rounded()
    let noteChanged = note != initialNote
    let dateChanged = !Calendar.current.isDate(date, inSameDayAs: initialDate)
    let bodyFatChanged: Bool = {
        switch (bodyFatPercentage, initialBodyFat) {
        case (.none, .none): return false
        case (.some, .none), (.none, .some): return true
        case let (.some(a), .some(b)): return (a * 10).rounded() != (b * 10).rounded()
        }
    }()
    return weightChanged || noteChanged || dateChanged || bodyFatChanged
}
```

**Date navigation for new entries (replace static Text with arrows):**
```swift
private var canNavigateForward: Bool {
    !Calendar.current.isDateInToday(date)
}

// In body, for !isEditing case:
HStack {
    Button {
        if let newDate = Calendar.current.date(byAdding: .day, value: -1, to: date) {
            date = newDate
        }
    } label: {
        Image(systemName: "chevron.left")
            .font(.title2)
    }

    Text(date, format: .dateTime.weekday(.wide).month(.abbreviated).day())
        .font(.headline)
        .frame(maxWidth: .infinity)

    Button {
        if canNavigateForward,
           let newDate = Calendar.current.date(byAdding: .day, value: 1, to: date) {
            date = newDate
        }
    } label: {
        Image(systemName: "chevron.right")
            .font(.title2)
    }
    .disabled(!canNavigateForward)
}
.padding(.horizontal)
```

**Keep DatePicker for edit mode** (existing code stays for isEditing case)

**Weight input section (keep TextField, remove buttons):**
```swift
VStack(alignment: .leading, spacing: 8) {
    Text("Weight")
        .font(.headline)
        .foregroundStyle(.secondary)

    HStack(alignment: .firstTextBaseline, spacing: 4) {
        TextField("Weight", value: $weight, format: .number.precision(.fractionLength(1)))
            .font(.system(size: weightFontSize, weight: .medium))
            .keyboardType(.decimalPad)
            .fixedSize()
            .multilineTextAlignment(.trailing)
            .focused($focusedField, equals: .weight)

        Text(weightUnit.rawValue)
            .font(.title)
            .foregroundStyle(.secondary)
    }
}
.padding(.horizontal)
```

**Notes section (always visible, not just edit mode):**
```swift
private let noteCharacterLimit = 500
private var charactersRemaining: Int { noteCharacterLimit - note.count }

VStack(alignment: .leading, spacing: 8) {
    Text("Notes")
        .font(.headline)
        .foregroundStyle(.secondary)

    TextField("", text: $note, axis: .vertical)
        .textFieldStyle(.roundedBorder)
        .lineLimit(3...6)
        .focused($focusedField, equals: .notes)
        .onChange(of: note) { _, newValue in
            if newValue.count > noteCharacterLimit {
                note = String(newValue.prefix(noteCharacterLimit))
            }
        }

    if charactersRemaining < 50 {
        Text("\(charactersRemaining) characters remaining")
            .font(.caption)
            .foregroundStyle(charactersRemaining < 10 ? .red : .secondary)
    }
}
.padding(.horizontal)
```

**"More..." expandable section for body fat:**
```swift
VStack(spacing: 12) {
    Button {
        withAnimation(.spring(duration: 0.3)) {
            showMoreFields.toggle()
            if showMoreFields && bodyFatPercentage == nil {
                bodyFatPercentage = 20.0  // Default when expanding
            }
        }
    } label: {
        HStack {
            Text(showMoreFields ? "Less..." : "More...")
            Image(systemName: showMoreFields ? "chevron.up" : "chevron.down")
        }
        .font(.subheadline)
        .foregroundStyle(AppColors.primary)
    }

    if showMoreFields {
        VStack(alignment: .leading, spacing: 8) {
            Text("Body Fat %")
                .font(.headline)
                .foregroundStyle(.secondary)

            HStack(alignment: .firstTextBaseline, spacing: 4) {
                TextField("Body Fat", value: $bodyFatPercentage, format: .number.precision(.fractionLength(1)))
                    .font(.system(size: bodyFatFontSize, weight: .medium))
                    .keyboardType(.decimalPad)
                    .fixedSize()
                    .multilineTextAlignment(.trailing)
                    .focused($focusedField, equals: .bodyFat)

                Text("%")
                    .font(.title2)
                    .foregroundStyle(.secondary)
            }
        }
        .transition(.opacity.combined(with: .move(edge: .top)))
    }
}
.padding(.horizontal)
```

**Remove the Toggle("Include Body Fat %)** - replaced by More... expansion

**Add auto-focus on appear:**
```swift
.task {
    // Only auto-focus weight for new entries
    if !isEditing {
        focusedField = .weight
    }
}
```

**Add discard confirmation:**
```swift
.interactiveDismissDisabled(hasUnsavedChanges)
.alert("Discard Changes?", isPresented: $showDiscardAlert) {
    Button("Discard", role: .destructive) {
        dismiss()
    }
    Button("Keep Editing", role: .cancel) { }
} message: {
    Text("You have unsaved changes that will be lost.")
}
```

**Update Cancel button to check for unsaved changes:**
```swift
ToolbarItem(placement: .cancellationAction) {
    Button("Cancel") {
        if hasUnsavedChanges {
            showDiscardAlert = true
        } else {
            dismiss()
        }
    }
}
```

**Keep existing:**
- Navigation title logic (isEditing ? "Edit Entry" : "Add Weight")
- Save button logic (disabled when !isFormValid)
- saveEntry() function with HealthKit sync
- Validation logic (isValidWeight, isValidBodyFat, isFormValid)
- Timestamps section for edit mode
- Alert for save errors

**Update isValidBodyFat to work with showMoreFields:**
```swift
private var isValidBodyFat: Bool {
    guard showMoreFields, let bf = bodyFatPercentage else { return true }
    return bf >= 1.0 && bf <= 60.0
}
```

**Update init for initial values capture:**
Add let properties and set them in init:
```swift
init(entries: [WeightEntry], weightUnit: WeightUnit, existingEntry: WeightEntry? = nil) {
    // ... existing setup ...

    if let entry = existingEntry {
        // ... existing state setup ...
        self.initialWeight = entry.weightValue(in: weightUnit)
        self.initialNote = entry.note ?? ""
        self.initialDate = entry.date
        self.initialBodyFat = entry.bodyFatPercentage.map { NSDecimalNumber(decimal: $0).doubleValue }
    } else {
        let startWeight = entries.first?.weightValue(in: weightUnit) ?? weightUnit.defaultWeight
        // ... existing state setup ...
        self.initialWeight = startWeight
        self.initialNote = ""
        self.initialDate = Date()
        self.initialBodyFat = nil
    }
}
```

**Update saveEntry to handle body fat from showMoreFields:**
```swift
let bodyFat: Decimal? = showMoreFields && bodyFatPercentage != nil
    ? Decimal(bodyFatPercentage!)
    : nil
```

**Update previews** to remove any references that no longer work.
  </action>
  <verify>
Build succeeds: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build 2>&1 | grep -E "(error:|BUILD SUCCEEDED)"`
  </verify>
  <done>
- WeightEntryView builds without WeightAdjustmentButton imports
- @FocusState declared with EntryField enum
- .focused() modifier on weight, notes, bodyFat TextFields
- .task {} sets focusedField = .weight for new entries
- Date arrows visible for new entries (not edit mode)
- chevron.right disabled when date is today
- Notes field always visible with character limit
- Character counter shows when < 50 remaining
- More... button toggles body fat section with animation
- interactiveDismissDisabled(hasUnsavedChanges) present
- Discard confirmation alert defined
- Cancel button checks hasUnsavedChanges before dismissing
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Redesigned WeightEntryView with focused text input, date navigation, notes with character limit, expandable body fat section, and unsaved changes protection</what-built>
  <how-to-verify>
1. Launch the app in simulator
2. Tap the add entry button in tab bar
3. Verify: Weight field is auto-focused and keyboard shows decimal pad
4. Verify: Date shows with left/right arrows, right arrow disabled (today)
5. Tap left arrow - date changes to yesterday, right arrow enabled
6. Tap right arrow - back to today, right arrow disabled again
7. Enter a weight value - unit suffix (lb) appears next to number
8. Scroll down to see Notes field (always visible, not just edit mode)
9. Type in notes - verify it expands as you type
10. Type 460+ characters - verify counter appears, enforces 500 limit
11. Tap "More..." - body fat field slides in with animation
12. Tap "Less..." - body fat field slides out
13. With changes made, try to swipe-dismiss the sheet
14. Verify: Discard confirmation dialog appears
15. Tap "Keep Editing" - stays in form
16. Tap Cancel button - discard dialog appears again
17. Tap "Discard" - sheet dismisses
18. Open an existing entry for edit mode
19. Verify: DatePicker appears (not arrows) allowing any date selection
20. Verify: All fields show existing entry data
  </how-to-verify>
  <resume-signal>Type "approved" to continue to cleanup plan, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- Build succeeds without errors
- No references to WeightAdjustmentButton in WeightEntryView.swift
- Weight field receives focus on new entry sheet open
- Date arrows navigate correctly, right arrow disabled on today
- Notes field visible with character limit enforcement
- More... section expands/collapses with animation
- Unsaved changes prevents accidental dismissal
- Edit mode still uses DatePicker
</verification>

<success_criteria>
- Weight entry uses direct text input (no plus/minus buttons)
- Auto-focus works reliably via @FocusState + .task {}
- Date navigation via arrows for new entries, DatePicker for edit
- Notes always visible with 500-char limit and countdown
- Body fat in expandable "More..." section
- Discard confirmation protects unsaved changes
</success_criteria>

<output>
After completion, create `.planning/phases/15-weight-entry-screen/15-01-SUMMARY.md`
</output>
