---
phase: 01-critical-bugs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - W8Trackr/Models/Milestone.swift
  - W8Trackr/Views/Dashboard/DashboardView.swift
autonomous: true

must_haves:
  truths:
    - "Milestone popup shows only once per milestone achievement"
    - "Popup does not reappear when returning to dashboard"
    - "Popup shows again only when NEW milestone is achieved"
  artifacts:
    - path: "W8Trackr/Models/Milestone.swift"
      provides: "CompletedMilestone with celebrationShown flag"
      contains: "celebrationShown"
    - path: "W8Trackr/Views/Dashboard/DashboardView.swift"
      provides: "Conditional popup logic using celebrationShown"
      pattern: "celebrationShown.*false"
  key_links:
    - from: "DashboardView.swift"
      to: "CompletedMilestone.celebrationShown"
      via: "check before showing, set true on dismiss"
      pattern: "celebrationShown"
---

<objective>
Fix milestone celebration popup showing repeatedly on every dashboard visit

Purpose: Users see the milestone popup once when they achieve a milestone, not every time they open the dashboard. This is the most visible bug in the app.

Output: Modified CompletedMilestone model with tracking flag, updated dashboard logic to use it.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@W8Trackr/Models/Milestone.swift
@W8Trackr/Views/Dashboard/DashboardView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add celebrationShown flag to CompletedMilestone model</name>
  <files>W8Trackr/Models/Milestone.swift</files>
  <action>
Add a new property to the CompletedMilestone class:

```swift
var celebrationShown: Bool = false
```

Place it after the existing properties (after `startWeight`). The default value of `false` means newly created milestones will show their celebration, while migration will automatically set existing records to `false` (which is fine - if user already saw it, seeing once more is acceptable).

Do NOT modify the init() method - SwiftData will use the default value for new records.

Important: Follow SwiftData CloudKit rules - property has default value, so it's compatible.
  </action>
  <verify>Build succeeds: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build 2>&1 | tail -20`</verify>
  <done>CompletedMilestone has celebrationShown: Bool = false property</done>
</task>

<task type="auto">
  <name>Task 2: Update DashboardView to use celebrationShown flag</name>
  <files>W8Trackr/Views/Dashboard/DashboardView.swift</files>
  <action>
Modify the `checkForNewMilestone()` function to:

1. After creating and saving the CompletedMilestone, check its `celebrationShown` property before setting `celebrationMilestone`
2. Only set `celebrationMilestone = milestone` if `completed.celebrationShown == false`

Then modify the celebration overlay dismissal to mark the milestone as shown:

1. In the celebration overlay (around line 103-107), when the dismiss closure is called:
   - Find the CompletedMilestone that matches the milestone weight being celebrated
   - Set `celebrationShown = true` on it
   - Save the context

The updated logic in checkForNewMilestone should be:
```swift
// After inserting and saving:
if !completed.celebrationShown {
    celebrationMilestone = milestone
}
```

The dismiss handler needs to:
```swift
// Find and mark milestone as shown
if let completedMilestone = completedMilestones.first(where: {
    $0.targetWeight(in: preferredWeightUnit) == milestone
}) {
    completedMilestone.celebrationShown = true
    try? modelContext.save()
}
celebrationMilestone = nil
```

This ensures:
- Newly created milestones show popup (celebrationShown starts as false)
- Once dismissed, celebrationShown becomes true
- Next dashboard visit, the milestone exists but celebrationShown is true, so no popup
  </action>
  <verify>
Build succeeds: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build 2>&1 | tail -20`

Manual verification: Run app in simulator, achieve a milestone, dismiss popup, leave dashboard, return - popup should NOT reappear.
  </verify>
  <done>
- Popup only shows when celebrationShown == false
- Dismissing popup sets celebrationShown = true
- Returning to dashboard does not re-trigger popup for same milestone
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with no errors
2. Manual test: Create weight entries that cross a milestone threshold
3. Popup appears once
4. Navigate away from dashboard and back - popup does NOT reappear
5. Create another entry crossing NEXT milestone - popup appears for new milestone
</verification>

<success_criteria>
- CompletedMilestone model has celebrationShown: Bool = false property
- DashboardView only shows popup when celebrationShown is false
- Dismissing popup sets celebrationShown to true
- Build passes, no SwiftData migration issues
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bugs/01-01-SUMMARY.md`
</output>
