---
phase: 21-infrastructure-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - W8Trackr/W8Trackr.entitlements
  - W8Trackr/Shared/SharedModelContainer.swift
  - W8Trackr/Views/SettingsView.swift
autonomous: true

must_haves:
  truths:
    - "App Group entitlement exists in project configuration"
    - "SharedModelContainer provides single source of truth for container configuration"
    - "HealthKit settings alert opens Health privacy settings, not app settings"
  artifacts:
    - path: "W8Trackr/W8Trackr.entitlements"
      provides: "App Group capability"
      contains: "com.apple.security.application-groups"
    - path: "W8Trackr/Shared/SharedModelContainer.swift"
      provides: "Shared container configuration for app and future widgets"
      exports: ["SharedModelContainer", "appGroupIdentifier", "sharedModelContainer", "sharedDefaults"]
  key_links:
    - from: "W8Trackr/Shared/SharedModelContainer.swift"
      to: "group.com.saults.W8Trackr"
      via: "ModelConfiguration groupContainer parameter"
      pattern: "groupContainer.*identifier"
    - from: "W8Trackr/Views/SettingsView.swift"
      to: "Health privacy settings"
      via: "URL scheme for Health settings"
      pattern: "App-prefs.*HEALTH|x-apple-health"
---

<objective>
Configure App Group entitlement and shared model container for widget data sharing, and fix HealthKit settings navigation.

Purpose: Enable future widgets to access SwiftData by establishing the App Group infrastructure. Also fix the HealthKit settings link to navigate to the correct location (Health privacy settings instead of app settings).

Output: App Group entitlement, SharedModelContainer.swift, updated SettingsView.swift with correct Health settings URL
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-infrastructure-migration/21-RESEARCH.md
@W8Trackr/W8Trackr.entitlements
@W8Trackr/Models/WeightEntry.swift
@W8Trackr/Models/Milestone.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add App Group Entitlement and Create SharedModelContainer</name>
  <files>
    W8Trackr/W8Trackr.entitlements
    W8Trackr/Shared/SharedModelContainer.swift
  </files>
  <action>
1. Update W8Trackr.entitlements to add App Group capability:
   - Add key `com.apple.security.application-groups` with array containing `group.com.saults.W8Trackr`
   - Keep existing CloudKit and HealthKit entitlements

2. Create W8Trackr/Shared/ directory if it doesn't exist

3. Create SharedModelContainer.swift with:
   - `enum SharedModelContainer` (not class - stateless configuration)
   - `static let appGroupIdentifier = "group.com.saults.W8Trackr"`
   - `static var sharedModelContainer: ModelContainer` computed property that:
     - Creates Schema with WeightEntry.self and CompletedMilestone.self
     - Creates ModelConfiguration with `groupContainer: .identifier(appGroupIdentifier)`
     - Uses `cloudKitDatabase: .automatic` to preserve CloudKit sync
     - Returns ModelContainer, using fatalError if creation fails (app cannot function without data)
   - `static let sharedDefaults: UserDefaults?` for shared preferences (UserDefaults(suiteName:))

Note: This plan creates the infrastructure but does NOT yet switch the app to use it.
The migration plan (21-02) will handle the actual cutover.

Import SwiftData and Foundation. Follow project conventions:
- No force unwraps except for unrecoverable errors
- Use modern Swift patterns
  </action>
  <verify>
1. Build succeeds: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build`
2. Entitlements file contains App Group key
3. SharedModelContainer.swift compiles without warnings
  </verify>
  <done>
- W8Trackr.entitlements includes `com.apple.security.application-groups` with `group.com.saults.W8Trackr`
- SharedModelContainer.swift exists in W8Trackr/Shared/
- SharedModelContainer provides appGroupIdentifier, sharedModelContainer, and sharedDefaults
- Build succeeds with no new warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix HealthKit Settings Link Navigation</name>
  <files>
    W8Trackr/Views/SettingsView.swift
  </files>
  <action>
Update the HealthKit permission alert in SettingsView.swift to open the correct settings location.

Current code (around line 450-455):
```swift
Button("Open Settings") {
    if let settingsUrl = URL(string: UIApplication.openSettingsURLString) {
        UIApplication.shared.open(settingsUrl)
    }
}
```

Change to open Health privacy settings:
```swift
Button("Open Settings") {
    // Open Health app directly - more reliable than prefs: URL schemes
    // which may not work consistently across iOS versions
    if let healthURL = URL(string: "x-apple-health://"),
       UIApplication.shared.canOpenURL(healthURL) {
        UIApplication.shared.open(healthURL)
    } else if let settingsUrl = URL(string: UIApplication.openSettingsURLString) {
        // Fallback to app settings if Health app URL doesn't work
        UIApplication.shared.open(settingsUrl)
    }
}
```

The `x-apple-health://` URL opens the Health app directly, which is the most reliable way to guide users to manage Health permissions. The prefs:root URL schemes are undocumented and may not work consistently.

Also update the alert message to be more helpful:
- Change from "Please enable Health access in Settings to sync your weight data."
- To: "To sync weight data, open the Health app, tap your profile, select Apps, and enable W8Trackr."

Note: The notification permission alert should remain using UIApplication.openSettingsURLString since that correctly opens the app's notification settings.
  </action>
  <verify>
1. Build succeeds
2. SwiftLint passes: `swiftlint lint --strict W8Trackr/Views/SettingsView.swift`
3. Manual verification: When HealthKit permission is denied and user taps "Open Settings", it should open the Health app (or fall back to app settings)
  </verify>
  <done>
- HealthKit permission alert's "Open Settings" button opens Health app via x-apple-health:// URL
- Fallback to app settings if Health URL cannot be opened
- Alert message updated to guide user through Health app navigation
- Build succeeds, SwiftLint passes
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build`
2. SwiftLint passes: `swiftlint lint --strict`
3. Entitlements contain App Group
4. SharedModelContainer.swift exists and compiles
5. SettingsView uses Health app URL for HealthKit settings navigation
</verification>

<success_criteria>
- App Group entitlement configured (INFRA-01 foundation)
- SharedModelContainer ready for use by app and future widget extension
- HealthKit settings link navigates to Health app (INFRA-03 complete)
- All existing functionality preserved (no breaking changes)
- Build and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/21-infrastructure-migration/21-01-SUMMARY.md`
</output>
