---
phase: 25-localization
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - W8Trackr/Views/Analytics/WeeklySummaryCard.swift
  - W8Trackr/Views/Components/GoalPredictionView.swift
  - W8Trackr/Intents/AppShortcuts.swift
  - W8Trackr/Managers/NotificationScheduler.swift
  - W8Trackr/Managers/DataExporter.swift
  - W8TrackrWidget/Views/LargeWidgetView.swift
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Weight numbers display with locale-correct decimal separator (comma for Spanish, period for English)"
    - "All numeric displays use Swift's built-in number formatters"
    - "No String(format:) calls remain for user-facing weight values"
  artifacts:
    - path: "W8Trackr/Views/Analytics/WeeklySummaryCard.swift"
      provides: "Weekly summary with locale-aware number formatting"
      contains: ".formatted(.number"
    - path: "W8Trackr/Views/Components/GoalPredictionView.swift"
      provides: "Goal prediction with locale-aware formatting"
      contains: ".formatted(.number"
    - path: "W8Trackr/Intents/AppShortcuts.swift"
      provides: "Siri responses with locale-aware numbers"
      contains: ".formatted(.number"
  key_links:
    - from: "W8Trackr/Views/*.swift"
      to: "Locale.current"
      via: "Swift number formatter respects current locale"
      pattern: "\\.formatted\\("
---

<objective>
Replace String(format:) calls with locale-aware number formatting for Spanish decimal separator support.

Purpose: Ensure weight values display correctly in Spanish locale with comma decimal separator (LOCL-02)
Output: All user-facing numbers use .formatted(.number.precision(.fractionLength(1))) pattern
</objective>

<execution_context>
@~/.claude/agents/gsd-executor.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-localization/25-RESEARCH.md
@CLAUDE.md (Number Formatting section)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix number formatting in main app views</name>
  <files>
W8Trackr/Views/Analytics/WeeklySummaryCard.swift
W8Trackr/Views/Components/GoalPredictionView.swift
  </files>
  <action>
Replace all String(format: "%.1f", value) calls with locale-aware formatting.

**Pattern to find and replace:**
```swift
// BAD - ignores locale
String(format: "%.1f", weight)

// GOOD - respects locale (comma in Spanish, period in English)
weight.formatted(.number.precision(.fractionLength(1)))
```

**WeeklySummaryCard.swift** (3 occurrences):

1. Line ~136: `summary.averageWeight.map { String(format: "%.1f", $0) } ?? "--"`
   Replace with: `summary.averageWeight.map { $0.formatted(.number.precision(.fractionLength(1))) } ?? "--"`

2. Line ~150: `String(format: "%.1f", best.weight)`
   Replace with: `best.weight.formatted(.number.precision(.fractionLength(1)))`

3. Line ~172: `"\(prefix)\(String(format: "%.1f", value))"`
   Replace with: `"\(prefix)\(value.formatted(.number.precision(.fractionLength(1))))"`

**GoalPredictionView.swift** (4 occurrences):

1. Line ~68: `String(format: "%.1f %@/week (%@)", absVelocity, prediction.unit.rawValue, direction)`
   Replace with: `"\(absVelocity.formatted(.number.precision(.fractionLength(1)))) \(prediction.unit.rawValue)/week (\(direction))"`

2. Line ~87: Multiple String(format:) calls in accessibility label
   Replace: `String(format: "%.1f", goalWeight)` -> `goalWeight.formatted(.number.precision(.fractionLength(1)))`
   Replace: `String(format: "%.1f", abs(prediction.weeklyVelocity))` -> `abs(prediction.weeklyVelocity).formatted(.number.precision(.fractionLength(1)))`

3. Line ~95: `String(format: "%.1f", abs(prediction.weeklyVelocity))`
   Replace with: `abs(prediction.weeklyVelocity).formatted(.number.precision(.fractionLength(1)))`

4. Line ~97: `String(format: "%.1f", abs(prediction.weeklyVelocity))`
   Replace with: `abs(prediction.weeklyVelocity).formatted(.number.precision(.fractionLength(1)))`

**Important:** For accessibility labels, keep them as interpolated strings but use the formatter. The goal is locale-aware numbers, not localized text (that's handled by String Catalog).
  </action>
  <verify>
- No `String(format: "%.` patterns remain in WeeklySummaryCard.swift
- No `String(format: "%.` patterns remain in GoalPredictionView.swift
- Build succeeds: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build`
  </verify>
  <done>WeeklySummaryCard and GoalPredictionView use locale-aware number formatting</done>
</task>

<task type="auto">
  <name>Task 2: Fix number formatting in managers and intents</name>
  <files>
W8Trackr/Intents/AppShortcuts.swift
W8Trackr/Managers/NotificationScheduler.swift
W8Trackr/Managers/DataExporter.swift
W8TrackrWidget/Views/LargeWidgetView.swift
  </files>
  <action>
Replace String(format:) calls in backend code.

**AppShortcuts.swift** (6 occurrences):

1. Line ~107: `String(format: "%.1f", abs(change))`
   Replace with: `abs(change).formatted(.number.precision(.fractionLength(1)))`

2. Line ~110: `String(format: "%.1f", newestWeight)`
   Replace with: `newestWeight.formatted(.number.precision(.fractionLength(1)))`

3. Line ~112: Similar pattern
4. Line ~114: Similar pattern

5. Line ~151-153: Three String(format:) calls
   ```swift
   let changeAmount = String(format: "%.1f", abs(totalChange))
   let startFormatted = String(format: "%.1f", startWeight)
   let currentFormatted = String(format: "%.1f", currentWeight)
   ```
   Replace with:
   ```swift
   let changeAmount = abs(totalChange).formatted(.number.precision(.fractionLength(1)))
   let startFormatted = startWeight.formatted(.number.precision(.fractionLength(1)))
   let currentFormatted = currentWeight.formatted(.number.precision(.fractionLength(1)))
   ```

**NotificationScheduler.swift** (2 occurrences):

1. Line ~197: `String(format: "%.1f", abs(weightChange))`
   Replace with: `abs(weightChange).formatted(.number.precision(.fractionLength(1)))`

2. Line ~235: `String(format: "Just %.1f %@ to your next milestone of %.0f %@!", remaining, unit.rawValue, milestone, unit.rawValue)`
   Replace with:
   ```swift
   let remainingStr = remaining.formatted(.number.precision(.fractionLength(1)))
   let milestoneStr = milestone.formatted(.number.precision(.fractionLength(0)))
   content.body = "Just \(remainingStr) \(unit.rawValue) to your next milestone of \(milestoneStr) \(unit.rawValue)!"
   ```

**DataExporter.swift** (1 occurrence):

1. Line ~55: `String(format: "%.1f", entry.weightValue)`

   NOTE: For CSV export, we may WANT consistent decimal format (period) regardless of locale for data portability. Consider:
   - Option A: Use locale-aware for display consistency
   - Option B: Keep period for CSV data exchange standard

   For now, replace with locale-aware to match LOCL-02 requirement:
   Replace with: `entry.weightValue.formatted(.number.precision(.fractionLength(1)))`

   If data portability is a concern, this can be revisited with explicit locale:
   `entry.weightValue.formatted(.number.precision(.fractionLength(1)).locale(Locale(identifier: "en_US")))`

**LargeWidgetView.swift** (1 occurrence):

1. Line ~106: `"\(sign)\(String(format: "%.1f", diff)) \(entry.weightUnit)"`
   Replace with: `"\(sign)\(diff.formatted(.number.precision(.fractionLength(1)))) \(entry.weightUnit)"`
  </action>
  <verify>
- No `String(format: "%.` patterns remain in AppShortcuts.swift
- No `String(format: "%.` patterns remain in NotificationScheduler.swift
- No `String(format: "%.` patterns remain in DataExporter.swift (except if kept for CSV portability)
- No `String(format: "%.` patterns remain in LargeWidgetView.swift
- Build succeeds for both main app and widget
  </verify>
  <done>All managers, intents, and widget views use locale-aware number formatting</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Grep confirms no remaining String(format: "%.1f") in source files (excluding docs/specs)
2. Main app build succeeds
3. Widget build succeeds
4. Running app in Spanish locale shows comma decimal separators (75,5 kg instead of 75.5 kg)
</verification>

<success_criteria>
- All String(format: "%.Nf") replaced with .formatted(.number.precision(.fractionLength(N)))
- Build succeeds without warnings
- Weight numbers in Spanish locale display with comma separator
- LOCL-02 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/25-localization/25-04-SUMMARY.md`
</output>
