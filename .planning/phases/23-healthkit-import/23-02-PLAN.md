---
phase: 23-healthkit-import
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - W8Trackr/Managers/HealthSyncManager.swift
  - W8Trackr/Managers/HealthStoreProtocol.swift
  - W8Trackr/W8TrackrApp.swift
  - W8Trackr/Views/SettingsView.swift
autonomous: true

must_haves:
  truths:
    - "App sets up HKObserverQuery on launch when import is enabled"
    - "Background delivery is enabled for weight type"
    - "Observer query triggers incremental sync when Health data changes"
    - "User can enable/disable Health import from Settings"
    - "Initial sync runs automatically when user first enables import"
  artifacts:
    - path: "W8Trackr/Managers/HealthSyncManager.swift"
      provides: "Observer query setup and background delivery registration"
      exports: ["setupBackgroundDelivery", "isHealthImportEnabled"]
    - path: "W8Trackr/W8TrackrApp.swift"
      provides: "Background delivery initialization on app launch"
      contains: "setupBackgroundDelivery"
    - path: "W8Trackr/Views/SettingsView.swift"
      provides: "Import toggle in Health section"
      contains: "Import from Apple Health"
  key_links:
    - from: "W8TrackrApp"
      to: "HealthSyncManager.setupBackgroundDelivery"
      via: ".task modifier on app launch"
      pattern: "setupBackgroundDelivery"
    - from: "HKObserverQuery handler"
      to: "importWeightFromHealth"
      via: "Task async call in observer callback"
      pattern: "importWeightFromHealth.*modelContext"
    - from: "SettingsView import toggle"
      to: "HealthSyncManager.isHealthImportEnabled"
      via: "Toggle binding"
      pattern: "isHealthImportEnabled"
---

<objective>
Implement background sync and Settings UI for HealthKit import

Purpose: Enable automatic sync when Health data changes (HKIT-05) and provide user control (HKIT-01)
Output: Background delivery setup, observer query, Settings import toggle
</objective>

<execution_context>
@~/.claude/agents/gsd-executor.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-healthkit-import/23-RESEARCH.md
@.planning/phases/23-healthkit-import/23-01-SUMMARY.md
@W8Trackr/Managers/HealthSyncManager.swift
@W8Trackr/Managers/HealthStoreProtocol.swift
@W8Trackr/W8TrackrApp.swift
@W8Trackr/Views/SettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add background delivery and observer query to HealthSyncManager</name>
  <files>W8Trackr/Managers/HealthSyncManager.swift, W8Trackr/Managers/HealthStoreProtocol.swift</files>
  <action>
Add background delivery setup and observer query management to HealthSyncManager.

**Add new persisted state for import (HealthSyncManager.swift):**

```swift
/// User preference key for Health import enabled/disabled.
private static let healthImportEnabledKey = "healthImportEnabled"

/// Whether Health import is enabled by the user.
///
/// When enabled, the app imports weight data from Apple Health
/// and sets up background delivery for automatic sync.
var isHealthImportEnabled: Bool {
    get { userDefaults.bool(forKey: Self.healthImportEnabledKey) }
    set {
        userDefaults.set(newValue, forKey: Self.healthImportEnabledKey)
    }
}
```

**Add observer query property to track the running query:**

```swift
/// The currently running observer query for background updates.
/// Stored to allow stopping the query when import is disabled.
private var observerQuery: HKObserverQuery?
```

**Add background delivery setup method:**

```swift
// MARK: - Background Delivery

/// Sets up background delivery for weight data import.
///
/// Creates an HKObserverQuery to receive notifications when Health data changes,
/// then runs an incremental import using the anchored query.
///
/// CRITICAL: The completion handler MUST always be called in the observer callback.
/// Failure to call it causes HealthKit to use exponential backoff, eventually
/// stopping background delivery entirely.
///
/// - Parameter modelContext: The SwiftData context for importing entries
func setupBackgroundDelivery(modelContext: ModelContext) {
    guard Self.isHealthDataAvailable,
          isHealthImportEnabled,
          let weightType = weightType else {
        return
    }

    // Stop existing query if any
    if let existingQuery = observerQuery {
        healthStore.stop(existingQuery)
        observerQuery = nil
    }

    let query = HKObserverQuery(
        sampleType: weightType,
        predicate: nil
    ) { [weak self] _, completionHandler, error in
        // CRITICAL: Always call completion handler using defer
        // Missing this call causes exponential backoff and eventual delivery halt
        defer { completionHandler() }

        guard error == nil else {
            print("Observer query error: \(error!.localizedDescription)")
            return
        }

        // Run incremental import on main actor
        Task { @MainActor [weak self] in
            guard let self = self else { return }
            do {
                try await self.importWeightFromHealth(modelContext: modelContext)
            } catch {
                print("Background import failed: \(error)")
            }
        }
    }

    healthStore.execute(query)
    observerQuery = query

    // Enable background delivery with immediate frequency
    healthStore.enableBackgroundDelivery(
        for: weightType,
        frequency: .immediate
    ) { success, error in
        if !success, let error = error {
            print("enableBackgroundDelivery failed: \(error)")
        }
    }
}

/// Stops background delivery and clears the observer query.
///
/// Called when user disables Health import.
func stopBackgroundDelivery() {
    guard let weightType = weightType else { return }

    if let query = observerQuery {
        healthStore.stop(query)
        observerQuery = nil
    }

    // Optionally disable background delivery
    // Note: Not strictly required since query is stopped
    healthStore.disableBackgroundDelivery(for: weightType) { _, _ in }
}
```

**Add disableBackgroundDelivery to HealthStoreProtocol.swift:**

```swift
/// Disables background delivery for a data type.
/// - Parameters:
///   - type: The object type to stop monitoring
///   - completion: Called with success/failure
func disableBackgroundDelivery(
    for type: HKObjectType,
    withCompletion completion: @escaping @Sendable (Bool, Error?) -> Void
)
```

And add conformance in HKHealthStore extension:

```swift
func disableBackgroundDelivery(
    for type: HKObjectType,
    withCompletion completion: @escaping @Sendable (Bool, Error?) -> Void
) {
    disableBackgroundDelivery(for: type, withCompletion: completion)
}
```

**Important:**
- Use `defer { completionHandler() }` at the START of the observer callback - this is CRITICAL
- Store the observer query so it can be stopped when user disables import
- Use `.immediate` frequency for weight data (updates as soon as possible)
  </action>
  <verify>
Build the project:
```bash
xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build 2>&1 | tail -20
```
Confirm no build errors related to observer query or background delivery.
  </verify>
  <done>
HealthSyncManager has:
- `isHealthImportEnabled` persisted preference
- `setupBackgroundDelivery(modelContext:)` method with observer query
- `stopBackgroundDelivery()` method to disable sync
- Observer query with proper `defer { completionHandler() }` pattern
- HealthStoreProtocol extended with `disableBackgroundDelivery`
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize background delivery on app launch</name>
  <files>W8Trackr/W8TrackrApp.swift</files>
  <action>
Set up background delivery in the app's entry point when Health import is enabled.

**Add a `.task` modifier to set up background delivery after migration:**

Find the existing `.task` modifier that handles migration and extend it to also set up background delivery:

```swift
.task {
    // Perform migration in background if needed
    // App is usable while this runs
    if migrationManager.status == .pending {
        await migrationManager.performMigration()
    }

    // Set up HealthKit background delivery if import is enabled
    // This runs on every app launch to ensure observer query is active
    if healthSyncManager.isHealthImportEnabled {
        // Need to get a modelContext for the import
        // Use the shared container's mainContext
        let context = SharedModelContainer.sharedModelContainer.mainContext
        healthSyncManager.setupBackgroundDelivery(modelContext: context)
    }
}
```

**Important considerations:**
- Background delivery setup should run on every app launch (not just first launch)
- HKObserverQuery needs to be re-established each time the app launches
- Using `SharedModelContainer.sharedModelContainer.mainContext` for the model context
- This is non-blocking and runs after the view hierarchy is established
  </action>
  <verify>
Build the project:
```bash
xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build 2>&1 | tail -20
```
Confirm no build errors and that W8TrackrApp.swift compiles with the new background delivery setup.
  </verify>
  <done>
W8TrackrApp sets up background delivery on launch when import is enabled, using the shared model context
  </done>
</task>

<task type="auto">
  <name>Task 3: Add import toggle to Settings UI</name>
  <files>W8Trackr/Views/SettingsView.swift</files>
  <action>
Add an "Import from Apple Health" toggle to the Apple Health section in Settings.

**Update the healthSection to include the import toggle:**

Find the `healthSection` computed property and add a second toggle for import:

```swift
@ViewBuilder
private var healthSection: some View {
    if HealthSyncManager.isHealthDataAvailable {
        Section {
            // Existing export toggle
            Toggle("Sync to Apple Health", isOn: Binding(
                get: { healthSyncManager.isHealthSyncEnabled },
                set: { newValue in
                    if newValue {
                        Task {
                            do {
                                let success = try await healthSyncManager.requestAuthorization()
                                if success && healthSyncManager.isAuthorized {
                                    healthSyncManager.isHealthSyncEnabled = true
                                } else {
                                    showingHealthKitPermissionAlert = true
                                }
                            } catch {
                                showingHealthKitPermissionAlert = true
                            }
                        }
                    } else {
                        healthSyncManager.isHealthSyncEnabled = false
                    }
                }
            ))

            // NEW: Import toggle
            Toggle("Import from Apple Health", isOn: Binding(
                get: { healthSyncManager.isHealthImportEnabled },
                set: { newValue in
                    if newValue {
                        Task {
                            do {
                                // Request authorization (shows permission dialog)
                                let success = try await healthSyncManager.requestAuthorization()
                                if success {
                                    healthSyncManager.isHealthImportEnabled = true
                                    // Perform initial import (HKIT-04)
                                    try await healthSyncManager.importWeightFromHealth(modelContext: modelContext)
                                    // Set up background delivery
                                    healthSyncManager.setupBackgroundDelivery(modelContext: modelContext)
                                } else {
                                    showingHealthKitPermissionAlert = true
                                }
                            } catch {
                                showingHealthKitPermissionAlert = true
                            }
                        }
                    } else {
                        healthSyncManager.isHealthImportEnabled = false
                        healthSyncManager.stopBackgroundDelivery()
                    }
                }
            ))

            // Show sync status if either sync or import is enabled
            if healthSyncManager.isHealthSyncEnabled || healthSyncManager.isHealthImportEnabled {
                HStack {
                    Text("Sync Status")
                    Spacer()
                    syncStatusView
                }
            }
        } header: {
            Text("Apple Health")
        } footer: {
            Text("Sync saves your entries to Apple Health. Import reads weight data from other apps and devices.")
        }
    }
}
```

**Key behaviors:**
- When user enables import:
  1. Request authorization (will show permission dialog)
  2. Set `isHealthImportEnabled = true`
  3. Run initial import (`importWeightFromHealth`) - this is HKIT-04
  4. Set up background delivery for ongoing sync
- When user disables import:
  1. Set `isHealthImportEnabled = false`
  2. Stop background delivery (observer query)
- Updated footer text explains both features
- Sync status shows if either feature is enabled
  </action>
  <verify>
Build the project:
```bash
xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build 2>&1 | tail -20
```
Check for SwiftLint violations:
```bash
swiftlint lint --path W8Trackr/Views/SettingsView.swift 2>&1 | grep -E "warning|error" | head -10
```
  </verify>
  <done>
Settings has "Import from Apple Health" toggle that:
- Requests authorization when enabled
- Runs initial import automatically (HKIT-04)
- Sets up background delivery for ongoing sync (HKIT-05)
- Stops background delivery when disabled
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with no errors
2. HealthSyncManager has background delivery methods
3. W8TrackrApp initializes background delivery on launch
4. SettingsView has import toggle with proper authorization flow
5. No SwiftLint violations introduced
</verification>

<success_criteria>
- HKObserverQuery created with proper completion handler pattern (defer)
- enableBackgroundDelivery called with .immediate frequency
- Background delivery set up on app launch when import enabled
- Settings has "Import from Apple Health" toggle
- Initial import runs when user first enables import (HKIT-04)
- Background sync works when Health data changes (HKIT-05)
</success_criteria>

<output>
After completion, create `.planning/phases/23-healthkit-import/23-02-SUMMARY.md`
</output>
