---
phase: 04-code-quality
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - W8Trackr/Managers/HealthSyncManager.swift
  - W8Trackr/W8TrackrApp.swift
  - W8Trackr/Views/SettingsView.swift
  - W8Trackr/Views/HistorySectionView.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "HealthSyncManager uses @Observable @MainActor pattern"
    - "No @Published property wrappers in HealthSyncManager"
    - "No objectWillChange.send() calls in HealthSyncManager"
    - "Views using HealthSyncManager compile and work correctly"
  artifacts:
    - path: "W8Trackr/Managers/HealthSyncManager.swift"
      provides: "@Observable @MainActor singleton"
      contains: "@Observable @MainActor"
    - path: "W8Trackr/W8TrackrApp.swift"
      provides: "HealthSyncManager state"
      contains: "@State"
  key_links:
    - from: "W8Trackr/Views/SettingsView.swift"
      to: "HealthSyncManager.shared"
      via: "computed property access"
      pattern: "HealthSyncManager\\.shared"
    - from: "W8Trackr/Views/HistorySectionView.swift"
      to: "HealthSyncManager"
      via: "@Environment injection"
      pattern: "@Environment"
---

<objective>
Migrate HealthSyncManager from ObservableObject to @Observable @MainActor pattern

Purpose: Complete the manager migration started in 04-02. HealthSyncManager was missed during that plan and now blocks Truth #2 ("All async operations use Swift concurrency").

Output: HealthSyncManager using @Observable @MainActor with updated view bindings
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-quality/04-02-SUMMARY.md

# Reference for @Observable pattern established in 04-02
@W8Trackr/Managers/NotificationManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate HealthSyncManager to @Observable @MainActor</name>
  <files>W8Trackr/Managers/HealthSyncManager.swift</files>
  <action>
    Convert HealthSyncManager from ObservableObject to @Observable pattern:

    1. Replace `ObservableObject` with `@Observable @MainActor`:
       - Line 21-22: Change `@MainActor\nfinal class HealthSyncManager: ObservableObject` to `@Observable @MainActor\nfinal class HealthSyncManager`

    2. Remove `@Published` property wrappers:
       - Line 51: `@Published var syncStatus` -> `var syncStatus`
       - Line 54: `@Published var isAuthorized` -> `var isAuthorized`

    3. Remove `objectWillChange.send()` calls:
       - Line 74: Remove `objectWillChange.send()` in `isHealthSyncEnabled` setter
       - Line 83: Remove `objectWillChange.send()` in `lastHealthSyncDate` setter

    Note: The class is already `@MainActor` annotated, so only the ObservableObject -> @Observable change is needed for the class declaration.

    Follow the exact pattern from NotificationManager.swift (migrated in 04-02).
  </action>
  <verify>
    grep -n "@Observable\|@Published\|objectWillChange" W8Trackr/Managers/HealthSyncManager.swift
    Expected: Only "@Observable @MainActor" on class declaration, no @Published or objectWillChange
  </verify>
  <done>HealthSyncManager uses @Observable pattern with no @Published or objectWillChange.send()</done>
</task>

<task type="auto">
  <name>Task 2: Update View bindings for @Observable HealthSyncManager</name>
  <files>W8Trackr/W8TrackrApp.swift, W8Trackr/Views/SettingsView.swift, W8Trackr/Views/HistorySectionView.swift</files>
  <action>
    Update views to use @Observable pattern (see 04-02-SUMMARY.md patterns):

    1. W8TrackrApp.swift (line 14):
       - Change `@StateObject private var healthSyncManager = HealthSyncManager()`
       - To: `@State private var healthSyncManager = HealthSyncManager()`

    2. SettingsView.swift (line 15):
       - Change `@ObservedObject private var healthSyncManager = HealthSyncManager.shared`
       - To: `private var healthSyncManager: HealthSyncManager { HealthSyncManager.shared }`
       This uses computed property pattern for @Observable singletons (established in 04-02).

    3. HistorySectionView.swift (line 13):
       - Change `@EnvironmentObject private var healthSyncManager: HealthSyncManager`
       - To: `@Environment(HealthSyncManager.self) private var healthSyncManager`
       Update Preview modifiers (lines 210, 222, 236, 248):
       - Change `.environmentObject(HealthSyncManager())`
       - To: `.environment(HealthSyncManager())`

    Note: @Environment(Type.self) is the modern replacement for @EnvironmentObject with @Observable classes.
  </action>
  <verify>
    grep -n "@StateObject\|@ObservedObject\|@EnvironmentObject" W8Trackr/W8TrackrApp.swift W8Trackr/Views/SettingsView.swift W8Trackr/Views/HistorySectionView.swift
    Expected: No results (all migrated to @State/@Environment)
  </verify>
  <done>All views use @State/@Environment for HealthSyncManager (no @StateObject/@ObservedObject/@EnvironmentObject)</done>
</task>

<task type="auto">
  <name>Task 3: Verify build and manager consistency</name>
  <files>N/A</files>
  <action>
    1. Build the project to verify all changes compile:
       xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build

    2. Verify all managers now use @Observable @MainActor:
       grep -l "@Observable @MainActor" W8Trackr/Managers/*.swift

    3. Verify no ObservableObject remains in Managers:
       grep "ObservableObject" W8Trackr/Managers/*.swift

    Expected: All 4 managers (NotificationManager, HealthKitManager, CloudKitSyncManager, HealthSyncManager) use @Observable @MainActor.
  </action>
  <verify>
    Build succeeds; grep shows 4 managers with @Observable @MainActor; no ObservableObject in Managers
  </verify>
  <done>All Manager classes use consistent @Observable @MainActor pattern; build passes</done>
</task>

</tasks>

<verification>
1. `grep "@Observable @MainActor" W8Trackr/Managers/*.swift` returns all 4 manager files
2. `grep "ObservableObject\|@Published\|objectWillChange" W8Trackr/Managers/HealthSyncManager.swift` returns nothing
3. `grep "@StateObject\|@ObservedObject\|@EnvironmentObject" W8Trackr/**/*.swift` returns no HealthSyncManager references
4. Build succeeds without errors
</verification>

<success_criteria>
- HealthSyncManager uses @Observable @MainActor (matches other managers)
- No @Published property wrappers remain in HealthSyncManager
- No objectWillChange.send() calls remain in HealthSyncManager
- All views compile with updated bindings
- Truth #2 ("All async operations use Swift concurrency") satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-03-SUMMARY.md`
</output>
