---
phase: 04-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - W8Trackr/Views/Analytics/WeeklySummaryCard.swift
  - W8Trackr/Views/ChartSectionView.swift
  - W8Trackr/Views/ToastView.swift
  - W8Trackr/Views/CurrentWeightView.swift
  - W8Trackr/Views/WeightEntryView.swift
  - W8Trackr/Views/Goals/MilestoneProgressView.swift
  - W8Trackr/Views/Goals/MilestoneCelebrationView.swift
  - W8Trackr/Views/Onboarding/OnboardingView.swift
  - W8Trackr/Views/HistorySectionView.swift
  - W8Trackr/Views/Animations/AnimationModifiers.swift
  - W8Trackr/Views/Animations/ConfettiView.swift
autonomous: true

must_haves:
  truths:
    - "No deprecated .cornerRadius() calls remain in Views"
    - "No DispatchQueue usage remains in View files"
    - "Delayed actions use Task.sleep(for:) pattern"
    - "Cancellable timers use Task with cancellation check"
  artifacts:
    - path: "W8Trackr/Views/Analytics/WeeklySummaryCard.swift"
      provides: "Rounded corners via clipShape"
      contains: ".clipShape(.rect(cornerRadius:"
    - path: "W8Trackr/Views/HistorySectionView.swift"
      provides: "Undo timer via Task pattern"
      contains: "Task<Void, Never>"
  key_links:
    - from: "W8Trackr/Views/HistorySectionView.swift"
      to: "undo mechanism"
      via: "Task with sleep and cancellation"
      pattern: "Task\\.isCancelled"
---

<objective>
Replace deprecated SwiftUI APIs and migrate View-level GCD to Swift concurrency

Purpose: Eliminate deprecated .cornerRadius() calls and DispatchQueue patterns in Views to meet QUAL-01 and QUAL-02 requirements
Output: All View files use modern SwiftUI APIs (.clipShape) and Swift concurrency (Task.sleep)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-quality/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace all .cornerRadius() with .clipShape()</name>
  <files>
    W8Trackr/Views/Analytics/WeeklySummaryCard.swift
    W8Trackr/Views/ChartSectionView.swift
    W8Trackr/Views/ToastView.swift
    W8Trackr/Views/CurrentWeightView.swift
    W8Trackr/Views/WeightEntryView.swift
    W8Trackr/Views/Goals/MilestoneProgressView.swift
    W8Trackr/Views/Goals/MilestoneCelebrationView.swift
  </files>
  <action>
    Replace all 11 instances of .cornerRadius(N) with .clipShape(.rect(cornerRadius: N)):

    - WeeklySummaryCard.swift:166 - `.cornerRadius(12)` -> `.clipShape(.rect(cornerRadius: 12))`
    - ChartSectionView.swift:49 - `.cornerRadius(10)` -> `.clipShape(.rect(cornerRadius: 10))`
    - ToastView.swift:82 - `.cornerRadius(10)` -> `.clipShape(.rect(cornerRadius: 10))`
    - CurrentWeightView.swift:54 - `.cornerRadius(10)` -> `.clipShape(.rect(cornerRadius: 10))`
    - WeightEntryView.swift:248 - `.cornerRadius(8)` -> `.clipShape(.rect(cornerRadius: 8))`
    - WeightEntryView.swift:264 - `.cornerRadius(10)` -> `.clipShape(.rect(cornerRadius: 10))`
    - MilestoneProgressView.swift:66 - `.cornerRadius(10)` -> `.clipShape(.rect(cornerRadius: 10))`
    - MilestoneProgressView.swift:125 - `.cornerRadius(10)` -> `.clipShape(.rect(cornerRadius: 10))`
    - MilestoneCelebrationView.swift:74 - `.cornerRadius(12)` -> `.clipShape(.rect(cornerRadius: 12))`
    - MilestoneCelebrationView.swift:83 - `.cornerRadius(20)` -> `.clipShape(.rect(cornerRadius: 20))`
    - MilestoneCelebrationView.swift:213 - `.cornerRadius(10)` -> `.clipShape(.rect(cornerRadius: 10))`

    This is a direct 1:1 replacement with no behavioral changes.
  </action>
  <verify>
    Run: `grep -r "\.cornerRadius" W8Trackr/Views/` returns no results
    Run: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build` succeeds
  </verify>
  <done>Zero .cornerRadius() calls remain in Views directory</done>
</task>

<task type="auto">
  <name>Task 2: Migrate View GCD patterns to Task.sleep</name>
  <files>
    W8Trackr/Views/Onboarding/OnboardingView.swift
    W8Trackr/Views/ToastView.swift
    W8Trackr/Views/Goals/MilestoneCelebrationView.swift
    W8Trackr/Views/Animations/AnimationModifiers.swift
    W8Trackr/Views/Animations/ConfettiView.swift
  </files>
  <action>
    Migrate 7 DispatchQueue.main.asyncAfter patterns to Task.sleep:

    1. OnboardingView.swift:152 - Confetti dismiss delay
       Before: `DispatchQueue.main.asyncAfter(deadline: .now() + 2.5) { ... }`
       After: `Task { try? await Task.sleep(for: .seconds(2.5)); ... }`

    2. ToastView.swift:135 - Auto-dismiss delay
       Before: `DispatchQueue.main.asyncAfter(deadline: .now() + duration) { ... }`
       After: `Task { try? await Task.sleep(for: .seconds(duration)); ... }`

    3. MilestoneCelebrationView.swift:110 - Dismiss animation delay
       Before: `DispatchQueue.main.asyncAfter(deadline: .now() + 0.2) { onDismiss() }`
       After: `Task { try? await Task.sleep(for: .milliseconds(200)); onDismiss() }`

    4. AnimationModifiers.swift:182 - Toast dismiss delay
       Before: `DispatchQueue.main.asyncAfter(deadline: .now() + 0.2) { onDismiss() }`
       After: `Task { try? await Task.sleep(for: .milliseconds(200)); onDismiss() }`

    5. AnimationModifiers.swift:331 - Second toast dismiss delay
       Before: `DispatchQueue.main.asyncAfter(deadline: .now() + 0.2) { onDismiss() }`
       After: `Task { try? await Task.sleep(for: .milliseconds(200)); onDismiss() }`

    6. ConfettiView.swift:264 - Auto-dismiss confetti
       Before: `DispatchQueue.main.asyncAfter(deadline: .now() + 3.5) { ... }`
       After: `Task { try? await Task.sleep(for: .seconds(3.5)); ... }`

    Pattern to follow (from 04-RESEARCH.md):
    ```swift
    // Before
    DispatchQueue.main.asyncAfter(deadline: .now() + delay) {
        action()
    }

    // After
    Task {
        try? await Task.sleep(for: .seconds(delay))
        action()
    }
    ```

    Note: Views are already on MainActor via SwiftUI, so direct property assignment is safe.
  </action>
  <verify>
    Run: `grep -r "DispatchQueue" W8Trackr/Views/Onboarding/OnboardingView.swift W8Trackr/Views/ToastView.swift W8Trackr/Views/Goals/MilestoneCelebrationView.swift W8Trackr/Views/Animations/` returns no results (except HistorySectionView which is Task 3)
    Build succeeds
  </verify>
  <done>No DispatchQueue.main.asyncAfter patterns in specified View files</done>
</task>

<task type="auto">
  <name>Task 3: Migrate HistorySectionView DispatchWorkItem to Task</name>
  <files>
    W8Trackr/Views/HistorySectionView.swift
  </files>
  <action>
    Convert DispatchWorkItem-based undo timer to Task pattern:

    Before (lines 21, 141, 147):
    ```swift
    @State private var deleteWorkItem: DispatchWorkItem?

    let workItem = DispatchWorkItem { [self] in
        // undo action
    }
    deleteWorkItem = workItem
    DispatchQueue.main.asyncAfter(deadline: .now() + Self.undoTimeout, execute: workItem)
    ```

    After:
    ```swift
    @State private var deleteTask: Task<Void, Never>?

    deleteTask?.cancel()
    deleteTask = Task {
        try? await Task.sleep(for: .seconds(Self.undoTimeout))
        guard !Task.isCancelled else { return }
        // undo action
    }
    ```

    Key changes:
    1. Replace `@State private var deleteWorkItem: DispatchWorkItem?` with `@State private var deleteTask: Task<Void, Never>?`
    2. Replace `deleteWorkItem?.cancel()` with `deleteTask?.cancel()`
    3. Replace DispatchWorkItem creation + asyncAfter with Task + sleep
    4. Add `guard !Task.isCancelled else { return }` after sleep

    This preserves the undo-cancel behavior: calling cancel() on the Task before sleep completes prevents the action from executing.
  </action>
  <verify>
    Run: `grep -r "DispatchQueue\|DispatchWorkItem" W8Trackr/Views/HistorySectionView.swift` returns no results
    Run: `grep -r "DispatchQueue" W8Trackr/Views/` returns no results
    Build succeeds
    Test undo flow manually: delete entry, tap Undo before timeout, verify entry restored
  </verify>
  <done>HistorySectionView uses Task-based cancellable timer, no DispatchQueue in any View file</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `grep -r "\.cornerRadius" W8Trackr/Views/` returns empty (QUAL-02 complete)
2. `grep -r "DispatchQueue" W8Trackr/Views/` returns empty (QUAL-01 Views complete)
3. `grep -r "DispatchWorkItem" W8Trackr/Views/` returns empty
4. Build succeeds with no warnings related to these changes
</verification>

<success_criteria>
- Zero .cornerRadius() calls in Views directory
- Zero DispatchQueue usage in Views directory
- Zero DispatchWorkItem usage in Views directory
- Build passes
- Undo functionality in HistorySectionView works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-01-SUMMARY.md`
</output>
