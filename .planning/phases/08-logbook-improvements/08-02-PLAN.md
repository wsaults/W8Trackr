---
phase: 08-logbook-improvements
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - W8Trackr/Views/LogbookView.swift
  - W8Trackr/Views/HistorySectionView.swift
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Nav bar has filter button with filter icon"
    - "Filter menu displays Notes toggle and Milestones toggle"
    - "Filter menu has Day of Week submenu with all 7 days"
    - "Filtering by Notes shows only entries with notes"
    - "Filtering by Milestones shows entries near milestone weights"
    - "Filtering by Day of Week shows entries from selected days"
    - "Filter state persists during app session (until app restart)"
  artifacts:
    - path: "W8Trackr/Views/LogbookView.swift"
      provides: "Filter state management and toolbar Menu"
      contains: "Menu"
    - path: "W8Trackr/Views/HistorySectionView.swift"
      provides: "Filter application to entries"
      contains: "filteredEntries"
  key_links:
    - from: "W8Trackr/Views/LogbookView.swift"
      to: "W8Trackr/Views/HistorySectionView.swift"
      via: "Filter state passed as bindings"
      pattern: "showOnlyNotes|selectedDays|showMilestones"
---

<objective>
Add filter menu to logbook navigation bar with filtering functionality

Purpose: Allow users to quickly filter logbook entries by notes, milestones, or day of week for easier data review

Output: Functional filter button in nav bar with working filters that persist during session
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-logbook-improvements/08-RESEARCH.md
@.planning/phases/08-logbook-improvements/08-01-SUMMARY.md

# Existing files to modify
@W8Trackr/Views/LogbookView.swift
@W8Trackr/Views/HistorySectionView.swift
@W8Trackr/Models/WeightEntry.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filter state and Menu to LogbookView</name>
  <files>W8Trackr/Views/LogbookView.swift</files>
  <action>
Add filter state management and toolbar Menu to LogbookView:

1. Add filter state properties (in LogbookView struct):
   ```swift
   // Filter state - persists during session via @State
   @State private var showOnlyNotes = false
   @State private var showMilestones = false
   @State private var selectedDays: Set<Int> = []  // 1=Sunday, 2=Monday, ..., 7=Saturday
   ```

2. Add computed property for active filter indicator:
   ```swift
   private var hasActiveFilters: Bool {
       showOnlyNotes || showMilestones || !selectedDays.isEmpty
   }
   ```

3. Add helper for weekday names (respects locale):
   ```swift
   private var weekdayNames: [String] {
       Calendar.current.weekdaySymbols  // ["Sunday", "Monday", ...]
   }
   ```

4. Add filter Menu to toolbar (alongside existing + button):
   ```swift
   .toolbar {
       ToolbarItem(placement: .primaryAction) {
           HStack(spacing: 16) {
               // Filter menu
               Menu {
                   // Notes toggle
                   Toggle("With Notes", isOn: $showOnlyNotes)

                   // Milestones toggle
                   Toggle("Milestones", isOn: $showMilestones)

                   Divider()

                   // Day of Week submenu
                   Menu("Day of Week") {
                       ForEach(1...7, id: \.self) { day in
                           Toggle(weekdayNames[day - 1], isOn: Binding(
                               get: { selectedDays.contains(day) },
                               set: { isOn in
                                   if isOn {
                                       selectedDays.insert(day)
                                   } else {
                                       selectedDays.remove(day)
                                   }
                               }
                           ))
                       }

                       if !selectedDays.isEmpty {
                           Divider()
                           Button("Clear Days") {
                               selectedDays.removeAll()
                           }
                       }
                   }

                   if hasActiveFilters {
                       Divider()
                       Button("Clear All Filters", role: .destructive) {
                           showOnlyNotes = false
                           showMilestones = false
                           selectedDays.removeAll()
                       }
                   }
               } label: {
                   Image(systemName: hasActiveFilters ? "line.3.horizontal.decrease.circle.fill" : "line.3.horizontal.decrease.circle")
               }

               // Add entry button (existing)
               Button {
                   showingAddWeight = true
               } label: {
                   Image(systemName: "plus")
               }
           }
       }
   }
   ```

5. Pass filter state to HistorySectionView:
   ```swift
   HistorySectionView(
       entries: entries,
       weightUnit: preferredWeightUnit,
       showOnlyNotes: showOnlyNotes,
       showMilestones: showMilestones,
       selectedDays: selectedDays
   ) { entry in
       entryToEdit = entry
   }
   ```

Note: "Heights" filter is omitted per research - WeightEntry has no height property.
  </action>
  <verify>
Build succeeds. Check with `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build 2>&1 | grep -E "(error:|warning:.*LogbookView|BUILD)"`. Filter menu compiles without errors.
  </verify>
  <done>
LogbookView has filter state properties and toolbar Menu with toggles for Notes, Milestones, and Day of Week submenu
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement filtering logic in HistorySectionView</name>
  <files>W8Trackr/Views/HistorySectionView.swift</files>
  <action>
Update HistorySectionView to accept and apply filters:

1. Add filter parameters to struct:
   ```swift
   let showOnlyNotes: Bool
   let showMilestones: Bool
   let selectedDays: Set<Int>
   ```

2. Add default values to init or update call sites (for backward compatibility in previews):
   ```swift
   init(
       entries: [WeightEntry],
       weightUnit: WeightUnit,
       showOnlyNotes: Bool = false,
       showMilestones: Bool = false,
       selectedDays: Set<Int> = [],
       onEdit: ((WeightEntry) -> Void)? = nil
   ) {
       self.entries = entries
       self.weightUnit = weightUnit
       self.showOnlyNotes = showOnlyNotes
       self.showMilestones = showMilestones
       self.selectedDays = selectedDays
       self.onEdit = onEdit
   }
   ```

3. Define milestone thresholds for filtering:
   ```swift
   // Standard milestone percentages: 25%, 50%, 75%, 100%
   // For simplicity, show entries at "round" weights that could be milestones
   private static let milestoneWeights: Set<Double> = [
       150, 155, 160, 165, 170, 175, 180, 185, 190, 195, 200,
       205, 210, 215, 220, 225, 230, 235, 240, 245, 250
   ]  // Common milestone weights in 5-lb increments

   private func isNearMilestone(_ weight: Double) -> Bool {
       // Check if weight is within 0.5 of a milestone weight
       Self.milestoneWeights.contains { milestone in
           abs(weight - milestone) < 0.5
       }
   }
   ```

4. Update `visibleEntries` to apply filters (rename to include filtering):
   ```swift
   private var filteredEntries: [WeightEntry] {
       var result = entries.filter { entry in
           !pendingDeletes.contains { $0.id == entry.id }
       }

       // Filter: Notes only
       if showOnlyNotes {
           result = result.filter { entry in
               if let note = entry.note {
                   return !note.trimmingCharacters(in: .whitespaces).isEmpty
               }
               return false
           }
       }

       // Filter: Milestones
       if showMilestones {
           result = result.filter { entry in
               isNearMilestone(entry.weightValue(in: weightUnit))
           }
       }

       // Filter: Day of Week
       if !selectedDays.isEmpty {
           result = result.filter { entry in
               let weekday = Calendar.current.component(.weekday, from: entry.date)
               return selectedDays.contains(weekday)
           }
       }

       return result
   }
   ```

5. Update references from `visibleEntries` to `filteredEntries`:
   - In `rowDataList` computed property
   - In toolbar EditButton visibility check
   - In `undoMessage` count (keep using `pendingDeletes.count`)
   - In `onDelete` handler (use `filteredEntries[index]` through rowDataList)

6. Add empty state when filters result in no entries:
   ```swift
   if sortedMonths.isEmpty {
       ContentUnavailableView(
           "No Matching Entries",
           systemImage: "line.3.horizontal.decrease.circle",
           description: Text("Try adjusting your filters")
       )
   } else {
       List { ... }
   }
   ```

7. Update previews to test filtering:
   ```swift
   #Preview("With Notes Filter") {
       NavigationStack {
           HistorySectionView(
               entries: WeightEntry.sortedSampleData,
               weightUnit: .lb,
               showOnlyNotes: true
           )
       }
       .environment(HealthSyncManager())
   }
   ```
  </action>
  <verify>
Build and run in simulator. Test each filter:
1. Toggle "With Notes" - should show only entries that have notes
2. Toggle "Milestones" - should show entries at round weights (170, 175, etc.)
3. Select days in "Day of Week" - should show only entries from those weekdays
4. Combine filters - should show intersection of all active filters
5. "Clear All Filters" - should reset to showing all entries
6. Verify filter icon changes to filled when filters active
  </verify>
  <done>
HistorySectionView accepts filter parameters and applies them to entries, showing appropriate empty state when no entries match filters
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. Build: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build`
2. Manual testing in simulator:
   - Open Logbook tab
   - Tap filter icon in nav bar - menu appears
   - Toggle "With Notes" - list updates to show only entries with notes
   - Toggle off, toggle "Milestones" - list shows entries at milestone weights
   - Open "Day of Week" submenu - select Monday - shows only Monday entries
   - Verify filter icon is filled when any filter is active
   - Tap "Clear All Filters" - returns to full list
   - Navigate away to another tab and back - filters persist
   - Close and reopen app - filters reset (session-only persistence)
</verification>

<success_criteria>
- Filter button appears in nav bar with filter icon
- Menu contains: With Notes, Milestones, Day of Week submenu
- Each filter works correctly and can be combined
- Filter icon shows filled state when filters active
- Empty state shown when no entries match filters
- Filter state persists during navigation within session
- Filter state resets on app restart (per spec: "persists during session")
</success_criteria>

<output>
After completion, create `.planning/phases/08-logbook-improvements/08-02-SUMMARY.md`
</output>
