---
phase: 08-logbook-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - W8Trackr/Views/HistorySectionView.swift
  - W8Trackr/Views/Components/LogbookRowView.swift
  - W8Trackr/Views/Components/LogbookRowData.swift
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Logbook entries are grouped by month with clear section headers"
    - "Each row shows date with day number and weekday abbreviation"
    - "Each row shows entry weight value"
    - "Each row shows 7-day moving average"
    - "Each row shows weekly rate with directional arrow"
    - "Each row shows notes indicator when note exists"
  artifacts:
    - path: "W8Trackr/Views/Components/LogbookRowData.swift"
      provides: "Row data model with calculated moving average and weekly rate"
      exports: ["LogbookRowData", "TrendDirection"]
    - path: "W8Trackr/Views/Components/LogbookRowView.swift"
      provides: "Reusable row component with compact layout"
      contains: "LogbookRowView"
    - path: "W8Trackr/Views/HistorySectionView.swift"
      provides: "Month-sectioned list with enhanced rows"
      contains: "entriesByMonth"
  key_links:
    - from: "W8Trackr/Views/HistorySectionView.swift"
      to: "W8Trackr/Analytics/TrendCalculator.swift"
      via: "TrendCalculator.exponentialMovingAverage for moving average calculation"
      pattern: "TrendCalculator\\.exponentialMovingAverage"
    - from: "W8Trackr/Views/HistorySectionView.swift"
      to: "W8Trackr/Views/Components/LogbookRowView.swift"
      via: "LogbookRowView component used in ForEach"
      pattern: "LogbookRowView\\("
---

<objective>
Create month-sectioned logbook with enhanced row data display

Purpose: Transform flat logbook list into organized month sections with rich per-row data (moving average, weekly rate, notes indicator) for better tracking insights

Output: Month-grouped HistorySectionView with LogbookRowView component showing calculated metrics per entry
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-logbook-improvements/08-RESEARCH.md

# Existing files to reference
@W8Trackr/Views/HistorySectionView.swift
@W8Trackr/Analytics/TrendCalculator.swift
@W8Trackr/Views/Analytics/WeeklySummaryCard.swift
@W8Trackr/Models/WeightEntry.swift
@W8Trackr/Theme/Colors.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LogbookRowData model with calculated metrics</name>
  <files>W8Trackr/Views/Components/LogbookRowData.swift</files>
  <action>
Create `LogbookRowData.swift` with:

1. `TrendDirection` enum:
   - Cases: `.up`, `.down`, `.stable`
   - Computed `symbol`: "arrow.up" / "arrow.down" / "minus"
   - Computed `color`: `AppColors.warning` / `AppColors.success` / `AppColors.secondary`
   - Note: Down (losing weight) is green/success, Up (gaining) is warning

2. `LogbookRowData` struct (Identifiable):
   - `id: UUID` (use entry's id)
   - `entry: WeightEntry`
   - `movingAverage: Double?` (7-day EWMA in current unit)
   - `weeklyRate: Double?` (weight change over 7 days)
   - `hasNote: Bool`
   - Computed `weightChangeDirection: TrendDirection`:
     - If `abs(weeklyRate) < 0.1` return `.stable`
     - If `weeklyRate < 0` return `.down` (losing weight)
     - Else return `.up` (gaining weight)

3. Static factory method `buildRowData(entries:unit:) -> [LogbookRowData]`:
   - Sort entries by date descending (newest first)
   - Calculate trend using `TrendCalculator.exponentialMovingAverage(entries:span:)` with span: 7
   - Build dictionary keyed by `Calendar.current.startOfDay(for: date)` for O(1) lookup
   - For each entry, calculate weekly rate:
     - Find closest entry from 7+ days ago
     - Calculate `currentWeight - previousWeight` (positive = gained)
   - Return array of LogbookRowData with all calculated values
  </action>
  <verify>
Build succeeds with `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build 2>&1 | grep -E "(error:|warning:.*LogbookRowData|BUILD)"`. No errors.
  </verify>
  <done>
LogbookRowData.swift exists with TrendDirection enum and LogbookRowData struct including buildRowData factory method that calculates moving averages and weekly rates
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LogbookRowView component with compact layout</name>
  <files>W8Trackr/Views/Components/LogbookRowView.swift</files>
  <action>
Create `LogbookRowView.swift` as a reusable row component:

1. Properties:
   - `rowData: LogbookRowData`
   - `weightUnit: WeightUnit`
   - `onEdit: (() -> Void)?` (optional tap handler)

2. Layout (HStack with proper spacing):
   ```
   | 16   | 170.0  | 171.1  | arrow 0.2  | note-icon |
   | Tue  |        |        |            |           |
   ```

   - **Date column** (VStack, fixed width ~40):
     - Day number: `Text(entry.date, format: .dateTime.day())` - `.headline` font
     - Weekday: `Text(entry.date, format: .dateTime.weekday(.abbreviated))` - `.caption` font, `.secondary` style

   - **Weight column** (Spacer before):
     - `Text(entry.weightValue(in: unit), format: .number.precision(.fractionLength(1)))`
     - `.body.monospacedDigit()` font

   - **Moving Average column** (Spacer before):
     - If `rowData.movingAverage` exists:
       - `Text(avg, format: .number.precision(.fractionLength(1)))`
       - `.body.monospacedDigit()` font, `.secondary` foregroundStyle

   - **Weekly Rate column** (Spacer before):
     - If `rowData.weeklyRate` exists:
       - HStack(spacing: 2):
         - `Image(systemName: rowData.weightChangeDirection.symbol)` with direction color
         - `Text(abs(rate), format: .number.precision(.fractionLength(1)))` - `.caption.monospacedDigit()` font

   - **Notes indicator** (at end):
     - If `rowData.hasNote`:
       - `Image(systemName: "note.text")` - `.caption` font, `.secondary` style

3. Tap gesture:
   - `.contentShape(Rectangle())` for full-row tap area
   - `.onTapGesture { onEdit?() }`

4. Accessibility:
   - `.accessibilityElement(children: .ignore)`
   - `.accessibilityLabel()` combining date, weight, and trend info
   - `.accessibilityHint("Swipe right to edit, swipe left to delete")`

5. Add preview with sample data
  </action>
  <verify>
Build succeeds and preview renders correctly in Xcode. Verify with `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build 2>&1 | grep -E "(error:|warning:.*LogbookRowView|BUILD)"`. No errors.
  </verify>
  <done>
LogbookRowView.swift exists showing date (day+weekday), weight, moving average, weekly rate with arrow, and notes indicator in compact horizontal layout
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor HistorySectionView for month sections</name>
  <files>W8Trackr/Views/HistorySectionView.swift</files>
  <action>
Modify HistorySectionView to group entries by month and use LogbookRowView:

1. Add import for Components (if needed for LogbookRowView/LogbookRowData)

2. Add computed properties for month grouping:
   ```swift
   private var rowDataList: [LogbookRowData] {
       LogbookRowData.buildRowData(entries: visibleEntries, unit: weightUnit)
   }

   private var entriesByMonth: [Date: [LogbookRowData]] {
       Dictionary(grouping: rowDataList) { rowData in
           let components = Calendar.current.dateComponents([.year, .month], from: rowData.entry.date)
           return Calendar.current.date(from: components) ?? rowData.entry.date
       }
   }

   private var sortedMonths: [Date] {
       entriesByMonth.keys.sorted(by: >) // Newest first
   }
   ```

3. Update List body to use sections:
   ```swift
   List {
       ForEach(sortedMonths, id: \.self) { month in
           Section {
               ForEach(entriesByMonth[month] ?? []) { rowData in
                   LogbookRowView(rowData: rowData, weightUnit: weightUnit) {
                       onEdit?(rowData.entry)
                   }
                   .swipeActions(edge: .trailing, allowsFullSwipe: true) {
                       Button(role: .destructive) {
                           queueDelete(rowData.entry)
                       } label: {
                           Label("Delete", systemImage: "trash")
                       }
                   }
                   .swipeActions(edge: .leading, allowsFullSwipe: true) {
                       Button {
                           onEdit?(rowData.entry)
                       } label: {
                           Label("Edit", systemImage: "pencil")
                       }
                       .tint(AppColors.primary)
                   }
               }
           } header: {
               Text(month, format: .dateTime.month(.wide).year())
           }
       }
   }
   ```

4. Keep existing functionality:
   - `visibleEntries` filtering for pending deletes (unchanged)
   - `queueDelete`, `undoDelete`, `commitDeletes` (unchanged)
   - Toast for undo (unchanged)
   - EditButton in toolbar (unchanged)

5. Remove old row implementation (HStack with VStack for date) - now in LogbookRowView

6. Update previews to work with new section structure
  </action>
  <verify>
Build and run app in simulator. Navigate to Logbook tab. Verify:
1. Entries are grouped by month with headers like "January 2026"
2. Each row shows day number and weekday on left
3. Weight value displays correctly
4. Moving average shows (may be nil for recent entries)
5. Weekly rate shows with arrow (may be nil for entries without 7-day history)
6. Notes indicator appears for entries with notes
7. Swipe actions still work (edit/delete)
8. Undo toast still works after delete
  </verify>
  <done>
HistorySectionView displays entries grouped by month with section headers, using LogbookRowView for each row showing all calculated metrics
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. Build: `xcodebuild -project W8Trackr.xcodeproj -scheme W8Trackr -configuration Debug -sdk iphonesimulator build`
2. Visual verification in simulator:
   - Open Logbook tab
   - Confirm month headers (e.g., "January 2026", "December 2025")
   - Confirm row layout: date column | weight | moving avg | rate+arrow | note icon
   - Swipe left to delete, confirm undo toast
   - Swipe right to edit, confirm edit sheet opens
</verification>

<success_criteria>
- Logbook entries grouped by month with "Month Year" section headers
- Each row displays: day+weekday, weight value, moving average, weekly rate with directional arrow, notes indicator
- Existing swipe actions (edit/delete) and undo functionality preserved
- No build errors or warnings related to new components
</success_criteria>

<output>
After completion, create `.planning/phases/08-logbook-improvements/08-01-SUMMARY.md`
</output>
